[{"categories":null,"content":"Whole hugo blog in plain text!","date":"2024-02-01","objectID":"/transformer/","tags":["transformer"],"title":"深入理解transformer","uri":"/transformer/"},{"categories":null,"content":"transformer背景 ","date":"2024-02-01","objectID":"/transformer/:1:0","tags":["transformer"],"title":"深入理解transformer","uri":"/transformer/"},{"categories":null,"content":"主要内容 主要内容 attention设计原理解读 tranformer中的矩阵/行向量乘法 transformer的pytorch代码实现 计算量\\(O(N^2)\\) 源于softmax的存在 从kernel的角度来看attention \\(\\mathcal{A}(X_i) = \\dfrac{\\sum_{j=1}^{N} sim(Q_i,K_j) V_j}{\\sum_{j=1}^N sim(Q_i,K_j)}\\) linear attention 参考 Attention Is All You Need (Vaswani et al. 2023) Fast Autoregressive Transformers with Linear Attention (Katharopoulos et al. 2020) mingpt by karpathy ","date":"2024-02-01","objectID":"/transformer/:1:1","tags":["transformer"],"title":"深入理解transformer","uri":"/transformer/"},{"categories":null,"content":"回顾线性代数的知识 why 原文比较晦涩 \\[\\begin{aligned}\\mathrm{Attention}(Q,K,V)=\\mathrm{softmax}(\\dfrac{QK^T}{\\sqrt{d_k}})V \\\\ \\mathrm{MultiHead}(Q,K,V)=\\mathrm{Concat}(\\mathrm{head}_1,\\ldots,\\mathrm{head}_h)W^{O} \\\\ \\mathrm{head}_i=\\mathrm{Attention}(QW_i^Q, KW^{K}_i,VW^V_i) \\end{aligned}\\] 把矩阵剖解成从行向量来看更容易理解 矩阵和行向量 矩阵 \\(X\\in R^{N\\times F}\\) \\(X=\\begin{pmatrix} X_{11}, X_{12},\\ldots, X_{1F} \\\\ X_{21}, X_{22},\\ldots, X_{2F} \\\\ \\vdots\\\\ X_{N1}, X_{N2},\\ldots, X_{NF} \\end{pmatrix}\\) 行向量 \\(X_{i}=\\begin{pmatrix} X_{i1}, X_{i2},\\ldots, X_{iF}\\end{pmatrix}, X_i \\in R^{1\\times F}\\) 分块矩阵 \\(X=\\begin{pmatrix} X_1\\\\ X_2\\\\ \\vdots\\\\ X_N \\end{pmatrix}\\) 比如nn.Embedding 按照行向量来组织数据 import torch import torch.nn as nn N = 3 F = 8 embed = nn.Embedding(N, F) idx = torch.tensor([1,2,3]) X = embed(idx) print(X.shape) 例子 \\(N\\) 个token，\\(F\\) 是embedding的维度 每行对应于一个token的embedding 行向量 \\(tokens=\\begin{pmatrix} \\text{hello} \\\\ \\text{world} \\\\ \\text{pad} \\\\ \\text{pad} \\\\ \\text{pad} \\end{pmatrix}\\) \\(X=\\begin{pmatrix} [0.59, 0.20, 0.04, 0.96] \\\\ [0.96, 0.30, 0.16, 0.63] \\\\ [0.02, 0.19, 0.34, 0.25] \\\\ [0.02, 0.19, 0.34, 0.25] \\\\ [0.02, 0.19, 0.34, 0.25] \\end{pmatrix}\\) 矩阵相乘和算子作用 定义线性算子 \\(\\mathcal{A}\\) 可以作用到行向量 \\(\\mathcal{A}(X_i) = X_{i} A\\) 也可以作用到矩阵 \\(\\mathcal{A}(X) = XA\\) 右乘矩阵等于对每个行向量逐个施加行变换 \\(XA=\\begin{pmatrix} X_1\\\\ X_2\\\\ \\vdots\\\\ X_N \\end{pmatrix}A= \\begin{pmatrix} X_1 A\\\\ X_2 A\\\\ \\vdots\\\\ X_N A \\end{pmatrix}= \\begin{pmatrix} \\mathcal{A}(X_1) \\\\ \\mathcal{A}(X_2) \\\\ \\vdots\\\\ \\mathcal{A}(X_N) \\end{pmatrix}=\\mathcal{A}(X)\\) 代码对应于 nn.Linear import torch import torch.nn as nn F = 6 linear = nn.Linear(in_features=F, out_features=F) X_i = torch.rand(1, 6) X = torch.rand(3, 6) print(linear(X_i).shape) print(linear(X).shape) pytorch/tensorflow中的代码都是按照作用于行向量来组织的 从分块矩阵的乘法来看\\(QK^{T}V\\) \\(S=QK^T\\) 行向量两两计算点积相似性 \\(\\begin{pmatrix} Q_{1}\\\\ Q_{2}\\\\ \\vdots\\\\ Q_N \\end{pmatrix} \\begin{pmatrix} K_{1}^T, K_2^T,\\ldots,K_N^T\\\\ \\end{pmatrix}=(Q_{i}K_j^T)_{ij}=S\\) \\(SV\\) = 对行向量做加权求和 \\(\\begin{pmatrix} S_{11},S_{12},\\ldots, S_{1N}\\\\ S_{21},S_{22},\\ldots, S_{2N}\\\\ \\vdots\\\\ S_{N1},S_{N2},\\ldots, S_{NN}\\\\ \\end{pmatrix} \\begin{pmatrix} V_{1}\\\\ V_{2}\\\\ \\vdots\\\\ V_N \\end{pmatrix}= \\begin{pmatrix} \\sum\\limits_{j}S_{1j}V_j\\\\ \\sum\\limits_{j}S_{2j}V_j\\\\ \\vdots\\\\ \\sum\\limits_{j}S_{Nj}V_j \\end{pmatrix}\\) 基于Q,K计算相似性，然后基于V来加权求和 \\(QK^{T}V\\) 的每个行向量都是\\(V\\) 行向量的一个加权求和 注 左乘以一个矩阵相当于对每个列向量来施加变化 论文：一般会有行/列向量两种表示方式 代码：基本都是行向量来作为数据组织的标准 本文: 向量都按照行向量的形式来组织 按照作用于单个行向量的方式来讲解transformer ","date":"2024-02-01","objectID":"/transformer/:1:2","tags":["transformer"],"title":"深入理解transformer","uri":"/transformer/"},{"categories":null,"content":"encoder-decoder 大部分的s2s 的任务建模为 encoder-decoder的结构 机器翻译，语音识别，文本摘要，问答系统等 encoder 把token序列\\((x_{1}, x_2,\\ldots, x_N)\\) 转化为语义向量序列 \\((Y_{1}, Y_2, \\ldots, Y_N)\\) 一般组织为多层的网络的形式 第一层：基础语义向量序列 \\((x_{1}, x_2,\\ldots, x_N)\\rightarrow (X_{1}, X_2,\\ldots, X_N)\\) 其它层：从低阶语义向量转化为高阶语义向量序列 \\((X_{1}, X_2,\\ldots, X_N)\\rightarrow (Y_{1}, Y_2,\\ldots, Y_N)\\) decoder 基于\\((Y_{1}, Y_2, \\ldots, Y_N)\\) 自回归式的逐个token解码 focus到 encoder部分来理解transformer ","date":"2024-02-01","objectID":"/transformer/:1:3","tags":["transformer"],"title":"深入理解transformer","uri":"/transformer/"},{"categories":null,"content":"低阶到高阶语义向量的转换 encoder的主要工作是寻找算子\\(\\mathcal{T}\\) 将低阶的语义向量序列变换为高阶的语义向量序列 \\(\\mathcal{T}\\begin{pmatrix} X_1\\\\ X_2\\\\ \\vdots\\\\ X_N \\end{pmatrix} \\rightarrow\\begin{pmatrix} Y_1\\\\ Y_2\\\\ \\vdots\\\\ Y_N \\end{pmatrix}\\) 输入: \\(X\\) 低阶语义向量序列，输出: \\(Y\\) 高阶语义向量序列 意义 \\(Y_{i}=f(X_{1}, X_2, \\ldots, X_{N})\\) 对低阶语义向量做加工组合处理和抽象，变换为一个高阶的语义向量序列 高阶语义向量考虑了 上下文 的语义向量表达 motivation Firth a word is characterized by the company it keeps. 例子： The enigmatic smile on Mona Lisa’s face has intrigued art enthusiasts for centuries, leaving them to speculate about its true meaning. 用算子作用来表达 \\(Y=\\mathcal{T}(X)\\) \\(X \\in R^{N\\times F}\\), \\(Y=\\mathcal{T}(X): \\quad R^{N\\times F}\\rightarrow R^{N\\times F}\\) 这个算子天然可以复合嵌套，形成多层的网络结构 \\(Y=\\mathcal{T}_{L}\\circ \\mathcal{T}_{L-1}\\circ \\ldots \\circ \\mathcal{T}_{1}(X)\\) ","date":"2024-02-01","objectID":"/transformer/:1:4","tags":["transformer"],"title":"深入理解transformer","uri":"/transformer/"},{"categories":null,"content":"核心的问题 问题 如何设计 \\(Y_{i}=f(X_{1}, X_2, \\ldots, X_{N})\\) \\(Y_{1}, \\ldots, Y_N\\) 能否并行得到 \\(Y_{i}\\) 能否高效的建立起对周围token的远程依赖 RNN 递归语义序列 \\(Y_{0}\\rightarrow Y_1 \\rightarrow \\ldots \\rightarrow Y_{N}\\) \\(Y_{i}=tanh(X_{i}W + Y_{i-1}U)\\) 串行 单方向的依赖关系 \\(Y_{3}\\) 直接依赖于\\(Y_{2}, X_{3}\\), 间接依赖于\\(X_1\\) CNN \\(Y_{i}=(X_{i-1},X_i, X_{i+1}) W\\) 假设窗口宽度是3 并行 长距离依赖？ 一层卷积只能依赖于当前窗口内，不能对窗口外的形成依赖。 transformer思路 设计\\(Y_{i}=f(X_{1}, X_2, \\ldots, X_{N})\\)，使得 使得 \\(Y_{1},\\ldots, Y_N\\) 可以做并行计算 同时解决长距离依赖的问题 \\(Y=\\mathcal{F}\\circ \\mathcal{A}(X)\\) 做两次矩阵的变换 \\(Y=\\mathcal{A}(X)\\) MultiHead Attention 高阶的语义等于对 全部 的低阶语义向量基于 相似性(Attention) 做 加权平均 \\(\\begin{aligned}\\mathcal{A}(X_i) \u0026= \\frac{\\sum_{j=1}^{N} sim(X_i,X_j) X_j}{\\sum_{j=1}^N sim(X_i,X_j)} \\end{aligned}\\) attention = 相似性 \\(Y’=\\mathcal{F}(Y)\\) Position-wise Feedforward 再施加若干非线性变换 ","date":"2024-02-01","objectID":"/transformer/:1:5","tags":["transformer"],"title":"深入理解transformer","uri":"/transformer/"},{"categories":null,"content":"tranformer网络结构 ","date":"2024-02-01","objectID":"/transformer/:2:0","tags":["transformer"],"title":"深入理解transformer","uri":"/transformer/"},{"categories":null,"content":"基于KV查询的相似性计算 \\[\\begin{aligned}\\mathcal{A}(X_i) \u0026= \\frac{\\sum_{j=1}^{N} sim(X_i,X_j) X_j}{\\sum_{j=1}^N sim(X_i,X_j)} \\end{aligned}\\] 直接计算相似性？ 参数太少 投影到别的空间来计算相似度 \\(X_{i}\\rightarrow X_iW\\) \\(\\begin{aligned} \\mathcal{A}(X_i) \u0026= \\frac{\\sum_{j=1}^{N} sim(X_iW_1,X_jW_{2}) X_jW_3}{\\sum_{j=1}^N sim(X_iW_1,X_jW_2)} \\end{aligned}\\) 如果我们记 \\(X_{i}W_{1}=Q_i, X_iW_2=K_i, X_iW_3=V_{i}\\)， \\(\\begin{aligned}\\mathcal{A}(X_i) \u0026= \\frac{\\sum_{j=1}^{N} sim(Q_i,K_j) V_j}{\\sum_{j=1}^N sim(Q_i,K_j)} \\end{aligned}\\) 基于KV查询理解 把\\(X_i\\) 投影出三个向量 \\(Q_i,K_i,V_i\\) QKV KV 是大家熟悉的key-value存储 \\(K_{j}\\rightarrow V_{j}\\) Q 是查询使用的query向量 \\(Q_{i}\\) QKV的查询方法 query查询多个key，获取多个value 最后把这些value加权平均 \\(Q_i\\Rightarrow \\begin{pmatrix} K_{1}\\rightarrow V_{1}\\\\ K_2\\rightarrow V_2\\\\ \\vdots\\\\ K_N\\rightarrow V_N \\end{pmatrix} \\Rightarrow \\begin{pmatrix} sim(Q_i,K_1)V_{1} \\\\ sim(Q_i,K_2)V_{2} \\\\ \\vdots\\\\ sim(Q_i,K_N)V_N \\end{pmatrix}\\Rightarrow\\sum_{j=1}^N sim(Q_i,K_j)V_j\\) \\(\\begin{aligned}\\mathcal{A}(X_i) \u0026= \\frac{\\sum_{j=1}^{N} sim(Q_i,K_j) V_j}{\\sum_{j=1}^N sim(Q_i,K_j)} \\end{aligned}\\) 参数： 对应于\\(Q,K,V\\) 产生了三个投影矩阵 \\(W_{Q}, W_K,W_V\\) ","date":"2024-02-01","objectID":"/transformer/:2:1","tags":["transformer"],"title":"深入理解transformer","uri":"/transformer/"},{"categories":null,"content":"在一个低维空间做attention 单个头的attention 把\\(X_{i}\\) 从\\(F\\) 维空间投影到\\(D\\) 维空间 \\(W_{Q}\\in R^{F\\times D}, W_K\\in R^{F\\times D}, W_{V} \\in R^{F\\times M}\\) \\(Q_i = X_iW_{Q}, \\quad K_i = X_iW_{K}, \\quad V_i = X_iW_{V}\\) \\(Q_i\\) 和所有的\\(K_j\\) 做基于点积的相似度计算， 这里简单起见，我们省略掉了scaling \\(\\frac{1}{\\sqrt{D}}\\) \\(Q_iK^{T}=Q_i(K^T_1, \\ldots, K^T_N)=(Q_iK^T_1, \\ldots, Q_iK^T_N)\\) 对相似度的分布做softmax \\(S=\\mathrm{soft}(Q_iK^T_1, \\ldots, Q_iK^T_N)=(s_{i1},\\ldots, s_{iN})\\) \\(s_{i,j}= \\dfrac{exp(Q_iK_j^T)}{\\sum_{j=1}^N exp(Q_iK_j^T)}\\) 加权平均 \\(\\mathcal{A}(X_i)=\\sum_{j=1}^Ns_jV_j=(s_{i1},\\ldots, s_{iN}) \\begin{pmatrix} V_1\\\\ V_2\\\\ \\vdots\\\\ V_N\\end{pmatrix}\\) \\(\\mathcal{A}(X_i) = \\mathrm{soft}(Q_iK^{T})V = \\mathrm{soft}(X_iW_QW_K^TX^T)XW_V\\) 矩阵表达 \\(Y=\\mathcal{A}(X) =\\begin{pmatrix} \\mathcal{A}(X_1)\\\\ \\mathcal{A}(X_2)\\\\ \\vdots\\\\ \\mathcal{A}(X_N) \\end{pmatrix} =\\begin{pmatrix} \\mathrm{soft}(Q_1K^T)V\\\\ \\mathrm{soft}(Q_2K^T)V\\\\ \\vdots \\\\ \\mathrm{soft}(Q_NK^T)V \\end{pmatrix}=\\mathrm{soft}(QK^T)V\\) 简化符号 \\(sim(Q,K)V\\) 代码实现 import torch import torch.nn as nn import math from torch.nn import functional as F class SingleHeadAttention(nn.Module): def __init__(self, config): super().__init__() self.F = config[\"hidden_dim\"] #F self.D = config[\"subspace_dim\"] #D self.q_proj = nn.Linear(self.F, self.D) self.k_proj = nn.Linear(self.F, self.D) self.v_proj = nn.Linear(self.F, self.D) def forward(self, x): B, N, F = x.size() q = self.q_proj(x) k = self.k_proj(x) v = self.v_proj(x) att = (q @ k.transpose(-2, -1)) * (1.0 / math.sqrt(k.size(-1))) att = F.softmax(att, dim=-1) y = att @ v return y 注: \\(D\\neq F\\) 时，\\(\\mathcal{A}(X)\\) 还不可用 ","date":"2024-02-01","objectID":"/transformer/:2:2","tags":["transformer"],"title":"深入理解transformer","uri":"/transformer/"},{"categories":null,"content":"在多个低维空间做attention why Multi-head attention allows the model to jointly attend to information from different representation subspaces at different positions. 一词多义 把\\(F\\) 维的语义向量投影到 \\(H\\) 个不同的子空间中去计算相似加权组合 做法 每个头投做独立的Attention变换 \\(\\mathcal{A}^{h}(X)\\) 假设有\\(H\\) 个头，每个头作用的低维空间维度是\\(D\\) \\(D\\times H = F\\) 对\\(H\\) 个 \\(D\\) 行向量拼接 \\(W_O\\in R^{F\\times F}\\) \\(\\mathcal{A}(X) = \\mathrm{concat}(\\mathcal{A}^1(X), \\mathcal{A}^2(X), \\ldots, \\mathcal{A}^{H}(X) W_O\\) 或者对前面的符号简化 在第\\(j\\) 个子空间做单头注意力 \\(Y^{j}=sim(Q^{j}, K^{j})V^{j}\\) 合并 \\(Y=(Y^{1},\\ldots, Y^H)\\) 代码实现 # 参考 https://github.com/karpathy/minGPT/tree/master/mingpt import torch import torch.nn as nn import math from torch.nn import functional as F class SelfAttention(nn.Module): def __init__(self, config): super().__init__() self.H = config[\"n_head\"] self.F = config[\"hidden_dim\"] #F self.D = self.F // self.H #D # 一次把qkv 全部映射完成，对应W_Q, W_K, W_V self.qkv_proj = nn.Linear(self.F, 3 * self.F) # 最后的投影，对应于 $W_O$ self.out_proj = nn.Linear(self.F, self.F) def forward(self, x): B, N, F = x.size() q, k, v = self.qkv_proj(x).split(self.F, dim=-1) # matmul 只能在最后两个维度相乘，需要对NxD的矩阵相乘，做1,2维度的交换 k = k.view(B, N, self.H, self.D).transpose(1, 2) q = q.view(B, N, self.H, self.D).transpose(1, 2) v = v.view(B, N, self.H, self.D).transpose(1, 2) # (B,H,N,D) # 一次把多个头的映射全部完成, 对任意的(batch, head) att = (q @ k.transpose(-2, -1)) * (1.0 / math.sqrt(k.size(-1))) att = F.softmax(att, dim=-1) y = att @ v # (B,H,N,D) y = y.transpose(1, 2) # (B,N,H,D) # 最后两个维度合并 y = y.contiguous().view(B, N, F) y = self.out_proj(y) return y 代码示意 ","date":"2024-02-01","objectID":"/transformer/:2:3","tags":["transformer"],"title":"深入理解transformer","uri":"/transformer/"},{"categories":null,"content":"位置无关的全连接 两层的全连接 \\(\\mathcal{F}(X_i)=(g(X_iW_1)+b_1)W_2+b_2\\) 代码 import torch import torch.nn as nn class PWiseFeedForward(nn.Module): def __init__(self, config): super().__init__() self.F = config[\"F\"] self.proj_wide = nn.Linear(self.F, 4 * self.F) self.proj_narrow = nn.Linear(4 * self.F, self.F) self.act = nn.ReLU() def forward(self, x): return self.proj_narrow(self.act(self.proj_wide(x))) ","date":"2024-02-01","objectID":"/transformer/:2:4","tags":["transformer"],"title":"深入理解transformer","uri":"/transformer/"},{"categories":null,"content":"归一化 + 残差网络 \\(\\mathcal{T}(X)=\\mathcal{F}\\circ\\mathcal{A}(X)\\) Layer Normalization \\(\\mathcal{A}’(X)=\\mathcal{N}\\circ\\mathcal{A}(X)\\) \\(\\dfrac{x-\\mu}{\\sqrt{\\sigma}}\\gamma + \\beta,\\mu=\\dfrac{1}{d}\\sum\\limits_{i=1}^{d}x_{i}, \\sigma=\\sqrt{\\dfrac{1}{d}\\sum\\limits_{i=1}^{d}(x_{i}-\\mu)^{2}}\\) 可以看成是作用在行向量上的算子 行归一化 or 列归一化 在NLP的序列建模里面，Layer Normalization 在CV/CTR预估里面, Batch Normalization Why padding的影响 不同batch中\u003cpad\u003e个数不同，沿着token方向做归一化没有意义 每个位置做独立的归一化更有意义 输入矩阵例子 \\(\\begin{pmatrix} \\text{hello} \\\\ \\text{world} \\\\ \\text{pad} \\\\ \\text{pad} \\\\ \\text{pad} \\end{pmatrix} \\rightarrow X= \\begin{pmatrix} [0.59, 0.20, 0.04, 0.96] \\\\ [0.96, 0.30, 0.16, 0.63] \\\\ [0.02, 0.19, 0.34, 0.25] \\\\ [0.02, 0.19, 0.34, 0.25] \\\\ [0.02, 0.19, 0.34, 0.25] \\end{pmatrix}\\) 其他的可能选择 RMSNorm \\(\\dfrac{x}{\\text{RMS}(x)}, \\quad \\text{RMS}(x) = \\sqrt{\\frac{1}{d} \\sum_{i=1}^{d} x_i^2}\\) ","date":"2024-02-01","objectID":"/transformer/:2:5","tags":["transformer"],"title":"深入理解transformer","uri":"/transformer/"},{"categories":null,"content":"整体的变换 \\(Y=\\mathcal{T}(X)\\) Attention \\(Z=\\mathcal{N}\\circ(X+\\mathcal{A}(X))\\) 位置无关的全连接 \\(Y=\\mathcal{N}\\circ(X+\\mathcal{F}(Z))\\) residual network \\(\\mathcal{A}’(X)=\\mathcal{N}\\circ(X+\\mathcal{A}(X))\\) \\(\\mathcal{F}’(X)=\\mathcal{N}\\circ(X+\\mathcal{F}(X))\\) 多层 一个 \\(L\\) 层的transformer 模型 \\begin{equation*} \\begin{split} \\mathcal{T}(X) \u0026 = \\mathcal{T}_L \\circ \\ldots \\mathcal{T}_{2}\\circ \\mathcal{T}_{1}(X) \\end{split} \\end{equation*} 代码 import torch.nn as nn class Block(nn.Module): def __init__(self, config): super().__init__() self.layer_norm_1 = nn.LayerNorm(config[\"hiden_dim\"]) self.attn = SelfAttention(config) self.layer_norm_2 = nn.LayerNorm(config[\"hidden_dim\"]) self.mlp = PWiseFeedForward(config) def forward(self, x): x = self.layer_norm_1(x + self.attn(x)) x = self.layer_norm_2(x + self.mlp(x)) return x ","date":"2024-02-01","objectID":"/transformer/:2:6","tags":["transformer"],"title":"深入理解transformer","uri":"/transformer/"},{"categories":null,"content":"transformer参数和计算量 ","date":"2024-02-01","objectID":"/transformer/:3:0","tags":["transformer"],"title":"深入理解transformer","uri":"/transformer/"},{"categories":null,"content":"关于参数量 一般的模型增加复杂度的方式 增加深度，增加宽度 增加embedding的维度 增加词典的大小 各种dnn主要的参数位置 cnn: \\(Y_{i}=(X_{i-1},X_i, X_{i+1}) W\\) rnn: \\(Y_{i}=tanh(X_{i}W + Y_{i-1}U)\\) ","date":"2024-02-01","objectID":"/transformer/:3:1","tags":["transformer"],"title":"深入理解transformer","uri":"/transformer/"},{"categories":null,"content":"参数的分布 多头注意力 \\(4F^2\\) 每个头有 3个投影矩阵 \\(W_Q, W_K, W_V\\) 1个投影concat结果的矩阵 \\(W_O\\) 参数量: 假设投射到的子空间维度是\\(D\\), \\(H\\) 个子空间，\\(D\\times H = F\\) \\(F\\times D \\times 3 \\times H = 3F^{2}\\) \\(F^{2}\\) FFW \\(8F^2\\) 两个矩阵，先从\\(F\\) 变宽到\\(4F\\)，再收窄回来到\\(F\\) 参数量\\(F\\times4F + 4F\\times F= 8F^{2}\\) word embedding \\(E\\) 是token字典的大小 \\(E\\times F\\) total \\(L(12F^{2})+EF\\) model 维度 层数 头数 字典大小 参数量 bertBase 768 12 12 30000 110M bertLarge 1024 24 12 30000 340M ","date":"2024-02-01","objectID":"/transformer/:3:2","tags":["transformer"],"title":"深入理解transformer","uri":"/transformer/"},{"categories":null,"content":"linear transformer 两个算子的计算量 \\(\\mathcal{A}(X)\\) 计算量 \\(O(N^2)\\) \\(\\mathcal{F}(X)\\) 计算量 \\(O(N)\\) softmax 导致了\\(O(N^2)\\) 核心的计算量在这三个矩阵的相乘上，\\(QK^{T}V\\), 乘法的计算量密切依赖于矩阵组合的方式 有softmax的存在的话 只能先计算\\(H=QK^{T}\\), 对\\(H\\) 做softmax 变换后，再计算\\(HV\\) 乘法的计算量是 \\(N^2D+N^2M\\), 整体的复杂度是\\(O(N^{2})\\) \\(QK^TV=(QK^T)V=\\begin{pmatrix} H_{11},H_{12},\\ldots,H_{1N} \\\\ \\vdots\\\\ H_{N1},H_{N2},\\ldots,H_{NN} \\\\ \\end{pmatrix}V\\) 如果没有softmax的话 可以先计算后两个矩阵相乘\\(H=K^TV\\), 再计算\\(QH\\) 乘法的计算量是 \\(NDM+DMN=2NDM\\)，当\\(N\\gg D\\) 的时候, 计算量可以是\\(O(N)\\), \\(K^TV\\) 提前算出来缓存，大致如下面这个表达所示 \\(Q(K^TV)=\\begin{pmatrix} Q_1 \\\\ Q_2 \\\\ \\vdots\\\\ Q_{N} \\end{pmatrix}(K^TV)\\) kernel \\(\\mathcal{A}(X_i)=\\dfrac{\\sum_{j=1}^{N} sim(Q_i,K_j) V_j}{\\sum_{j=1}^N sim(Q_i,K_j)}\\) kernel: \\(k(x,y)=\u003c\\phi(x),\\phi(y)\u003e\\) \\(k(x,y)=(x\\cdot z)^2, \\phi(x)=(x_{1}^{2},x_{2}^2,\\sqrt{2}x_1x_{2})\\) kernel 对应一个feature map 可以用非负的kernel来替换掉 当前的sim函数 \\(sim(x,y)=\\mathrm{exp}(xy^{T}/\\sqrt{D})\\) linear transformer \\(O(N)\\) 用kernel来替换掉sim \\[\\begin{aligned}\\mathcal{A}(X_i) \u0026= \\frac{\\sum_{j=1}^{N} sim(Q_i,K_j) V_j}{\\sum_{j=1}^N sim(Q_i,K_j)} \\\\ \u0026=\\frac{\\sum_{j=1}^{N} \\phi(Q_i)\\phi(K_j)^T V_j}{\\sum_{j=1}^N \\phi(Q_i)\\phi(K_j)^T} \\\\ \u0026=\\frac{ \\phi(Q_i) \\sum_{j=1}^{N}\\phi(K_j)^T V_j}{\\phi(Q_i)\\sum_{j=1}^N \\phi(K_j)^T} \\end{aligned} \\] \\(\\sum_{j=1}^{N}\\phi(K_j)^T V, \\sum_{j=1}^N \\phi(K_j)^T\\) 可以提前算好 \\(O(N)\\) 复杂度，Linear Transformer \\(\\phi(x)=\\mathrm{elu}(x)+1\\) ","date":"2024-02-01","objectID":"/transformer/:3:3","tags":["transformer"],"title":"深入理解transformer","uri":"/transformer/"},{"categories":null,"content":"总结 attention的设计原理解读 从低阶语义向量到高阶语义向量的转化 \\(\\mathcal{T}\\begin{pmatrix} X_1\\\\ X_2\\\\ \\vdots\\\\ X_N \\end{pmatrix} \\rightarrow\\begin{pmatrix} Y_1\\\\ Y_2\\\\ \\vdots\\\\ Y_N \\end{pmatrix}\\) \\(\\begin{aligned}\\mathcal{A}(X_i) \u0026= \\frac{\\sum_{j=1}^{N} sim(X_i,X_j) X_j}{\\sum_{j=1}^N sim(X_i,X_j)} \\end{aligned}\\) \\(\\mathcal{A}(X_i)=\\dfrac{\\sum_{j=1}^{N} sim(X_iW_Q,X_jW_{K}) X_jW_{V}}{\\sum_{j=1}^N sim(X_iW_Q,X_jW_K)}\\) \\(\\begin{aligned}\\mathcal{A}(X_i) \u0026= \\frac{\\sum_{j=1}^{N} sim(Q_i,K_j) V_j}{\\sum_{j=1}^N sim(Q_i,K_j)} \\end{aligned}\\) transformer的核心两次变换 \\(Y=\\mathcal{F}\\circ \\mathcal{A}(X)\\) 做两次矩阵的变换 核心的计算量在这三个矩阵的相乘上，\\(QK^{T}V\\) \\((QK^T)V\\) 计算量 \\(O(N^2)\\) \\(Q(K^TV)\\) 计算量 \\(O(N)\\) linear transformer \\[\\begin{aligned}\\mathcal{A}(X_i) \u0026= \\frac{\\sum_{j=1}^{N} sim(Q_i,K_j) V_j}{\\sum_{j=1}^N sim(Q_i,K_j)} \\\\ \u0026=\\frac{\\sum_{j=1}^{N} \\phi(Q_i)\\phi(K_j)^T V_j}{\\sum_{j=1}^N \\phi(Q_i)\\phi(K_j)^T} \\\\ \u0026=\\frac{ \\phi(Q_i) \\sum_{j=1}^{N}\\phi(K_j)^T V_j}{\\phi(Q_i)\\sum_{j=1}^N \\phi(K_j)^T} \\end{aligned} \\] ","date":"2024-02-01","objectID":"/transformer/:3:4","tags":["transformer"],"title":"深入理解transformer","uri":"/transformer/"},{"categories":null,"content":"参考论文 Katharopoulos, Angelos, Apoorv Vyas, Nikolaos Pappas, and François Fleuret. 2020. “Transformers Are RNNs: Fast Autoregressive Transformers with Linear Attention.” Arxiv.Org. https://arxiv.org/abs/2006.16236v3. Vaswani, Ashish, Noam Shazeer, Niki Parmar, Jakob Uszkoreit, Llion Jones, Aidan N. Gomez, Lukasz Kaiser, and Illia Polosukhin. 2023. “Attention Is All You Need.” arXiv. https://arxiv.org/abs/1706.03762. ","date":"2024-02-01","objectID":"/transformer/:4:0","tags":["transformer"],"title":"深入理解transformer","uri":"/transformer/"},{"categories":null,"content":"Whole hugo blog in plain text!","date":"2024-03-15","objectID":"/positional_embedding/","tags":["transformer","rope"],"title":"旋转位置编码","uri":"/positional_embedding/"},{"categories":null,"content":"背景 ","date":"2024-03-15","objectID":"/positional_embedding/:1:0","tags":["transformer","rope"],"title":"旋转位置编码","uri":"/positional_embedding/"},{"categories":null,"content":"主要内容 旋转位置编码在大模型中应用广泛 google PaLM meta llama 内容 旋转位置编码的来龙去脉 基于实数域上的旋转变换来推演 pytorch 代码实现 tricks 重新看解绝对位置编码 \\(\\begin{aligned} P_{i,2t} \u0026= sin(i/10000^{2t/D}) \\\\ P_{i,2t+1} \u0026= cos(i/10000^{2t/D}) \\end{aligned}\\) 参考： Enhanced Transformer with Rotary Position Embedding (Su et al. 2022) Attention Is All You Need (Vaswani et al. 2023) hugging face llama ","date":"2024-03-15","objectID":"/positional_embedding/:1:1","tags":["transformer","rope"],"title":"旋转位置编码","uri":"/positional_embedding/"},{"categories":null,"content":"回顾transformer encoder: 寻找算子\\(\\mathcal{T}\\) 低阶语义向量序列转化为高阶的语义向量序列 \\(\\mathcal{T}\\begin{pmatrix} X_1\\\\ X_2\\\\ \\vdots\\\\ X_N \\end{pmatrix} \\rightarrow\\begin{pmatrix} Y_1\\\\ Y_2\\\\ \\vdots\\\\ Y_N \\end{pmatrix}\\) \\(Y=\\mathcal{T}(X)=\\mathcal{F}(\\mathcal{A}(X))\\) Attention \\(\\mathcal{A}\\) Feedforward \\(\\mathcal{F}\\) Attention \\(\\begin{aligned}Q_{i} \u0026= X_{i} W_{Q} \\\\ K_{i} \u0026= X_{i} W_{K}\\\\ V_{i} \u0026= X_{i} W_{V}\\\\ Y_{i} \u0026= \\sum_{j=1}^{N}sim(Q_i,K_{j}) V_j\\\\ sim(Q_{i},K_j) = \u0026= \\frac{exp(\\frac{Q_{i}K_{j}^{T}}{\\sqrt{D}})} {\\sum_{j=1}^N exp(\\frac{Q_iK_j^{T}}{\\sqrt{D}})}\\\\ \\end{aligned}\\) ","date":"2024-03-15","objectID":"/positional_embedding/:1:2","tags":["transformer","rope"],"title":"旋转位置编码","uri":"/positional_embedding/"},{"categories":null,"content":"为什么需要位置编码 因为transformer结构本身是和位置无关的 \\(Y=\\mathcal{T}(X)=\\mathcal{F}(\\mathcal{A}(X))\\) 高阶语义向量不仅仅是由周围token的语义向量组合表达而成 还需要加上每个token所处的位置 下面的cls token得到的语义向量是完全一样的。 \u003ccls\u003e 从 北京 到 上海 的 火车票 \u003ccls\u003e 从 上海 到 北京 的 火车票 其他的网络结构天然有序列的位置信息 RNN/CNN ","date":"2024-03-15","objectID":"/positional_embedding/:1:3","tags":["transformer","rope"],"title":"旋转位置编码","uri":"/positional_embedding/"},{"categories":null,"content":"如何加入位置编码 \\(\\mathcal{T}(X)=\\mathcal{F}(\\mathcal{A}(X))\\) \\(\\mathcal{F}\\) 是位置无关的 可以修改 \\(X\\) 或者 \\(\\mathcal{A}\\) ","date":"2024-03-15","objectID":"/positional_embedding/:2:0","tags":["transformer","rope"],"title":"旋转位置编码","uri":"/positional_embedding/"},{"categories":null,"content":"直接修改输入 在\\(X_i \\rightarrow Q_i, K_i, V_i\\) 之前，直接加入位置的embedding \\(X_i^{’}=X_i+P_i\\) learned embedding 优点简单，bert/GPT 外推困难，对于超过序列最大长度的位置 自定义绝对位置编码 二维函数 f(position, dimension) 要求 函数随着position,dimension增长应该是有界的 足够的区分度，对每个position,对应的行向量应该是不同的 例子 \\(\\begin{aligned} P_{i,2t} \u0026= sin(k/10000^{2t/D}) \u0026\u0026\\\\ P_{i,2t+1} \u0026= cos(k/10000^{2t/D})\u0026\u0026\\\\ \\end{aligned}\\) \\(t\\in[0,1,\\ldots,D/2-1], i\\ge0\\) 问题: 语义应该是和相对位置有关的，而不是绝对位置 ","date":"2024-03-15","objectID":"/positional_embedding/:2:1","tags":["transformer","rope"],"title":"旋转位置编码","uri":"/positional_embedding/"},{"categories":null,"content":"修改Attention Attention \\(\\begin{aligned}Q_{i} \u0026= X_{i} W_{Q} \\\\ K_{i} \u0026= X_{i} W_{K}\\\\ V_{i} \u0026= X_{i} W_{V}\\\\ Y_{i} \u0026= \\sum_{j=1}^{N}sim(Q_i,K_{j}) V_j\\\\ sim(Q_{i},K_j) \u0026= \\frac{exp(\\frac{Q_{i}K_{j}^{T}}{\\sqrt{D}})} {\\sum_{j=1}^N exp(\\frac{Q_iK_j^{T}}{\\sqrt{D}})}\\\\ \\end{aligned}\\) 想法 可以从相似性入手，i和j之间的语义的相似性应该包含相对的距离信息 希望相似性计算只依赖向量还有相对距离,而不依赖于其绝对的位置。 \\(Q_{i}K_j^T=g(X_{i},X_j,i-j)\\) ","date":"2024-03-15","objectID":"/positional_embedding/:2:2","tags":["transformer","rope"],"title":"旋转位置编码","uri":"/positional_embedding/"},{"categories":null,"content":"回顾矩阵的知识 关于行向量和矩阵 定义线性算子 \\(\\mathcal{A}\\) 可以作用到行向量 \\(\\mathcal{A}(X_i) = X_{i} A\\) 也可以作用到矩阵 \\(\\mathcal{A}(X) = XA\\) 右乘矩阵等于对每个行向量逐个施加行变换 线性算子是对矩阵乘法的一种物理理解 旋转变换 \\(R(\\theta)= \\begin{pmatrix} cos\\theta\u0026 sin\\theta\\\\ -sin\\theta\u0026 cos\\theta \\end{pmatrix}\\) 缩放变换 \\(R(\\lambda_1,\\lambda_2)=\\begin{pmatrix} \\lambda_1 \u0026 \\\\ \u0026 \\lambda_2 \\\\ \\end{pmatrix}\\) 用对角阵在正交的子空间上施加不同的行变换 假设有两个方阵A,B，设 \\(X= (X^1, X^2)\\), 那么 \\((X^1,X^2)\\begin{pmatrix} A \u0026 0 \\\\ 0 \u0026 B \\end{pmatrix} = (X^1A, X^2 B)\\) 注： pytorch/tensorflow 中的矩阵相关代码都是按照行向量来组织的 在ROPE 论文是按照列向量来撰写的，表现为是用矩阵左乘以一个列向量 本文中出现的向量全部用行向量来表达，和代码一致 关于旋转矩阵 在二维子空间的旋转矩阵 \\(R(\\theta)= \\begin{pmatrix} cos\\theta\u0026 sin\\theta\\\\ -sin\\theta\u0026 cos\\theta \\end{pmatrix}\\) 物理意义 \\(XR(\\theta)\\) 对\\(X\\) 逆时针旋转\\(\\theta\\) 证明 \\(X=\\rho(cos\\phi, sin\\phi)\\) \\(\\begin{aligned} \u0026XR(\\theta)\\\\ =\u0026\\rho(cos \\phi, sin \\phi) \\begin{pmatrix} cos\\theta\u0026 sin\\theta\\\\ -sin\\theta\u0026 cos\\theta \\end{pmatrix} \\\\ =\u0026 \\rho( cos\\phi cos\\theta - sin\\phi sin\\theta, cos\\phi sin\\theta + sin\\phi cos\\theta )\\\\ =\u0026 \\rho(cos(\\phi+\\theta), sin(\\phi+\\theta)) \\end{aligned}\\) 性质 \\(R(\\theta)^T=R(-\\theta)\\) \\(R(\\theta_1)R(\\theta_2)=R(\\theta_1+\\theta_{2})\\) 在高维空间中旋转 假设空间是偶数维的，把原始的空间切分成为一个正交的二维子空间，在上面做独立的旋转。 定义 \\(\\Theta=(\\theta_{1},\\theta_2,\\ldots,\\theta_{D/2})\\) \\(R(\\Theta)=\\begin{pmatrix} cos\\,\\theta_{1} \u0026 sin\\,\\theta_1 \u0026 0 \u0026 0 \u0026 0 \u0026 0 \u00260\\\\ -sin\\,\\theta_{1} \u0026 cos\\,\\theta_1 \u0026 0 \u0026 0 \u0026 0 \u0026 0 \u00260 \\\\ 0 \u0026 0 \u0026 cos\\,\\theta_{2} \u0026 sin\\,\\theta_2 \u0026 0 \u0026 0 \u00260 \\\\ 0 \u0026 0 \u0026 -sin\\,\\theta_{2} \u0026 cos\\,\\theta_2\u0026 0 \u0026 0 \u00260 \\\\ 0 \u0026 0 \u0026 0 \u0026 0 \u0026 \\ldots \u00260 \u0026 0 \\\\ 0 \u0026 0 \u0026 0 \u0026 0 \u0026\\ldots \u0026 cos\\,\\theta_{D/2} \u0026 sin\\,\\theta_{D/2} \\\\ 0 \u0026 0 \u0026 0 \u0026 0 \u0026\\ldots \u0026 -sin\\,\\theta_{D/2} \u0026 cos\\,\\theta_{D/2} \\end{pmatrix}\\) \\(R(\\Theta)=\\begin{pmatrix} R(\\theta_{1}) \u0026 0 \u00260 \u0026 0\\\\ 0 \u0026 R(\\theta_2) \u0026 0 \u00260 \\\\ 0 \u0026 0 \u0026\\ldots \u00260 \\\\ 0 \u0026 0 \u0026 0 \u0026R(\\theta_{D/2})\\\\ \\end{pmatrix}\\) 性质 在独立的二维子空间上做不同角度的旋转 \\(XR(\\Theta)=(X^1, X^2) \\begin{pmatrix} R(\\theta_{1}) \u0026 0 \\\\ 0 \u0026 R(\\theta_2) \\end{pmatrix}=(X^1R(\\theta_1), X^2R(\\theta_2))\\) \\(R(\\Theta)=\\widehat{R}(\\theta_1)\\widehat{R}(\\theta_2)\\ldots\\widehat{R}(\\theta_{D/2})\\) 逐个在不同的子空间上做旋转 定义 \\(\\widehat{R}(\\theta)= \\begin{pmatrix} R(\\theta) \u0026 0 \\\\ 0 \u0026 1 \\\\ \\end{pmatrix}\\) \\(R(\\Theta)=\\begin{pmatrix} R(\\theta_{1}) \u0026 0 \\\\ 0 \u0026 R(\\theta_2) \\end{pmatrix}=\\begin{pmatrix} R(\\theta_{1}) \u0026 0 \\\\ 0 \u0026 1 \\\\ \\end{pmatrix}\\begin{pmatrix} 1 \u0026 0 \\\\ 0 \u0026 R(\\theta_2) \\end{pmatrix}=\\widehat{R}(\\theta_1)\\widehat{R}(\\theta_2)\\) ","date":"2024-03-15","objectID":"/positional_embedding/:2:3","tags":["transformer","rope"],"title":"旋转位置编码","uri":"/positional_embedding/"},{"categories":null,"content":"旋转位置编码 ","date":"2024-03-15","objectID":"/positional_embedding/:3:0","tags":["transformer","rope"],"title":"旋转位置编码","uri":"/positional_embedding/"},{"categories":null,"content":"motivation 假设\\(Q_{i}, K_j\\) 都是二维的向量，\\(i, j\\) 是它们对应的position， 这里\\(\\eta_{i},\\eta_{j}\\) 是\\(Q_i, K_j\\) 弧度表示. 点积只和模长和夹角有关 \\(Q_iK_j^T=\\|Q_i\\|\\|K_j\\| cos(\\eta_{j}-\\eta_i)\\), 如何在这里融入位置的信息？基于位置乘倍数旋转之后做点击 做法： 我们把两个向量各自旋转\\(i\\theta,j\\theta\\) 后再来计算点积 其中\\(\\theta\\) 是一个单位角度， 新的向量的内积带上了位置信息，且他们的内积只和\\(Q_i,Q_j,i-j\\) 相关 因为: 模长没有变，只是夹角变了，夹角增加了 \\((j-i)\\theta\\). \\(Q_iR(i\\theta)(K_jR(j\\theta))^T=\\|Q_i\\|\\|K_j\\| cos(\\eta_{j}-\\eta_{i}+(j-i)\\theta)\\) ","date":"2024-03-15","objectID":"/positional_embedding/:3:1","tags":["transformer","rope"],"title":"旋转位置编码","uri":"/positional_embedding/"},{"categories":null,"content":"二维空间中的一个解 基于旋转矩阵的一个解 \\begin{equation*} \\begin{split} Q_{i}\u0026= X_{i} W_{Q} R(i\\theta) \\\\ K_{j}\u0026= X_j W_{K} R(j\\theta)\\\\ Q_{i}K_j^T \u0026=X_{i}W_QR(i\\theta)R(j\\theta)^{T}W_K^{T}X_{j}^T\\\\ \u0026=X_{i}W_QR(i\\theta)R(-j\\theta)W_K^{T}X_{j}^T\\\\ \u0026=X_{i}W_QR((i-j)\\theta)W_K^{T}X_{j}^T\\\\ \u0026 =g(X_i,X_j,i-j)\\\\ \\end{split} \\end{equation*} 为什么是在投影之后旋转，不在投影之前转？ \\begin{equation*} \\begin{split} Q_{i}\u0026= X_{i} R(i\\theta) W_{Q} \\\\ K_{j}\u0026= X_j R(j\\theta) W_{K} \\\\ Q_{i}K_j^T \u0026=X_{i}R(i\\theta)W_QW_KR(j\\theta)^{T}X_{j}^T\\\\ \u0026=?\\\\ \\end{split} \\end{equation*} ","date":"2024-03-15","objectID":"/positional_embedding/:3:2","tags":["transformer","rope"],"title":"旋转位置编码","uri":"/positional_embedding/"},{"categories":null,"content":"推广到高维空间 整个空间分割成\\(D/2\\) 个子空间，在各个子空间上分别按照一个位置相关的角度旋转 定义 \\(R(i\\Theta)\\) \\(X_{i}R(i\\Theta)\\) 表示对\\(X_{i}\\) 在各个子空间分别做角度为\\(i\\theta_1,i\\theta_2,\\ldots,i\\theta_{D/2}\\) 的旋转. \\(\\Theta=(\\theta_{1},\\theta_2,\\ldots,\\theta_{D/2})\\) \\(R(i \\Theta)=\\begin{pmatrix} cos\\,i\\theta_{1} \u0026 sin\\,i\\theta_1 \u0026 0 \u0026 0 \\\\ -sin\\,i\\theta_{1} \u0026 cos\\,i\\theta_1 \u0026 0 \u0026 0 \\\\ 0 \u0026 0 \u0026 cos\\,i\\theta_{2} \u0026 sin\\,i\\theta_2 \\\\ 0 \u0026 0 \u0026 -sin\\,i\\theta_{2} \u0026 cos\\,i\\theta_2 \\\\ \\end{pmatrix}=\\begin{pmatrix} R(i\\theta_{1}) \u0026 0 \\\\ 0 \u0026 R(i\\theta_2) \\end{pmatrix}\\) ROPE在高维空间 \\begin{equation*} \\begin{split} Q_{i}\u0026 = X_{i} W_{Q} R(i\\Theta) \\\\ K_{j}\u0026 = X_j W_{K} R(j\\Theta)\\\\ Q_{i}K_j^T \u0026=X_{i}W_QR(i\\Theta)R(j\\Theta)^{T}W_K^{T}X_{j}^{T}\\\\ \u0026=X_{i}W_QR(i\\Theta)R(-j\\Theta)W_K^{T}X_{j}^{T}\\\\ \u0026=X_{i}W_QR((i-j)\\Theta)W_K^{T}X_{j}^{T}\\\\ \u0026=g(X_i,X_j,i-j)\\\\ \\end{split} \\end{equation*} 其中 \\begin{equation*} \\begin{split} R(i\\Theta)R(j\\Theta)^{T} \u0026= \\widehat{R}(i\\theta_1)\\widehat{R}(i\\theta_2)\\ldots\\widehat{R}(i\\theta_{D/2})\\widehat{R}(j\\theta_{D/2})^{T}\\ldots \\widehat{R}(j\\theta_{2})^{T} \\widehat{R}(j\\theta_{1})^{T} \\\\ \u0026= (\\widehat{R}(i\\theta_1)\\widehat{R}(j\\theta_1)^T)(\\widehat{R}(i\\theta_2)\\widehat{R}(j\\theta_2)^T)\\ldots(\\widehat{R}(i\\theta_{D/2}\\widehat{R}(j\\theta_{D/2})^T)\\\\ \u0026= \\widehat{R}((i-j)\\theta_1)\\widehat{R}((i-j)\\theta_2)\\ldots \\widehat{R}((i-j)\\theta_{D/2})\\\\ \u0026= R((i-j)\\Theta)\\\\ \\end{split} \\end{equation*} ","date":"2024-03-15","objectID":"/positional_embedding/:3:3","tags":["transformer","rope"],"title":"旋转位置编码","uri":"/positional_embedding/"},{"categories":null,"content":"整体看下 空间是\\(D\\) 维度，\\(d=D/2\\) 有\\(d\\) 个正交的二维子空间 \\(\\mathcal{X}_1, \\mathcal{X}_2, \\dots, \\mathcal{X}_{d}\\) 每个子空间\\(\\mathcal{X}_{k}\\) 有一个旋转角度基准 \\(\\theta_{k}\\), 一个基准旋转矩阵 \\(R(\\theta_{k})\\) 合并后的基准角度序列和旋转序列是 \\(\\Theta, R(\\Theta)\\) 每个子空间对应于三角函数中的一个周期 \\(2\\pi/\\theta_{k}\\) 对于每个位置\\(i\\), 角度序列和旋转序列是 \\(i\\Theta, R(i\\Theta)\\) \\(\\Theta\\) \\(\\theta_1\\) \\(\\theta_2\\) \\(\\theta_3\\) \\(\\ldots\\) \\(\\theta_{d}\\) \\(R(\\Theta)\\) \\(R(\\theta_1)\\) \\(R(\\theta_{2})\\) \\(R(\\theta_3)\\) \\(\\ldots\\) \\(R(\\theta_{d})\\) \\(i\\Theta\\) \\(i\\theta_1\\) \\(i\\theta_{2}\\) \\(i\\theta_3\\) \\(\\ldots\\) \\(i\\theta_{d}\\) 具体化 \\(\\theta_{k}\\) 是超参数 \\(\\theta_{k}=10000^{-2(k-1)/D}, k\\in[1,2,\\ldots,D/2]\\)，记\\(B=10000^{1/d}\\) \\(\\theta_{k}=1/B^{k-1}\\) 是一个几何级数 周期随着维度\\(k\\) 逐渐增大 \\(\\Theta\\) \\(1\\) \\(1/B\\) \\(1/B^{2}\\) \\(\\ldots\\) \\(1/B^{d-1}\\) \\(T\\) \\(2\\pi\\) \\(2B\\pi\\) \\(2B^{2}\\pi\\) \\(\\ldots\\) \\(2B^{d-1}\\pi\\) 随着位置的增大，位置编码是否会重复？ 如果存在位置$i$和 0 位置的编码撞车了， \\(\\Theta\\) 序列在 \\(2\\pi\\) 周期整数倍上撞车 \\(\\Theta\\) 全部都是 $2π$的整数倍 对dimension的每个\\(k\\), 存在着一个整数 \\(I_k\\), 使得\\(i\\theta_{k}=2\\pi I_k\\) 不可能，\\(\\theta_k=1/10000^{k/d}\\) 和 \\(2\\pi\\) 不会扯上关系 RoPE 可能的另外一个优势 在多个block 前向传递的过程中position的信息不会丢失 每个block都会先做QKV的投影，然后QK投影之后会做位置旋转变换 ","date":"2024-03-15","objectID":"/positional_embedding/:3:4","tags":["transformer","rope"],"title":"旋转位置编码","uri":"/positional_embedding/"},{"categories":null,"content":"再看下绝对位置编码 \\(\\begin{aligned} P_{i,2t} \u0026= sin(i/10000^{2t/D}) \u0026\u0026\\\\ P_{i,2t+1} \u0026= cos(i/10000^{2t/D})\u0026\u0026\\\\ \\end{aligned}\\) \\(t\\in[0,1,\\ldots,D/2-1], i\\ge0\\) 如果记\\(d=D/2,B=1/10000^{1/d}\\)， 那么\\(\\theta_{k}=1/B^{k-1}, k\\in[1,2,\\ldots,d]\\) structure 有\\(d\\) 个正交的二维子空间 \\(\\mathcal{X}_1, \\mathcal{X}_2, \\dots, \\mathcal{X}_{d}\\) 每个子空间\\(\\mathcal{X}_{k}\\) 有一个基础角度 \\(\\theta_{k}\\)， 两个基底, 记作\\(\\text{Tri}(\\theta_k)=(sin(\\theta_k), cos(\\theta_k))\\) 合并后的基准角度序列和基底序列是 \\(\\Theta, \\text{Tri} (\\Theta)\\) 由 \\(\\theta_{k}\\) 来决定各个子空间的不同 子空间内部由sin,cos 来区分 对于每个位置\\(i\\), 基准角度序列和基底序列是 \\(i\\Theta, \\text{Tri}(i\\Theta)\\) \\(\\Theta\\) \\(\\theta_1\\) \\(\\theta_{2}\\) \\(\\theta_3\\) \\(\\ldots\\) \\(\\theta_{d}\\) \\(\\text{Tri}(\\Theta)\\) \\(\\text{Tri}(\\theta_1)\\) \\(\\text{Tri}(\\theta_{2})\\) \\(\\text{Tri}(\\theta_3)\\) \\(\\ldots\\) \\(\\text{Tri}(\\theta_{d})\\) \\(i\\Theta\\) \\(i\\theta_1\\) \\(i\\theta_{2}\\) \\(i\\theta_3\\) \\(\\ldots\\) \\(i\\theta_{d}\\) 具体化 \\(\\theta_{k}=1/B^{k-1}\\) 是一个几何级数序列 周期随着维度\\(k\\) 逐渐增大 \\(\\Theta\\) \\(0\\) \\(1/B\\) \\(1/B^{2}\\) \\(\\ldots\\) \\(1/B^{d}\\) \\(T\\) \\(2\\pi\\) \\(2B\\pi\\) \\(2B^{2}\\pi\\) \\(\\ldots\\) \\(2B^{d}\\pi\\) 如果我们记录 \\(i=x\\) \\(\\{sin(\\theta_k x), cos(\\theta_{k} x)\\}_{k=1}^{D}\\) 很像对位置函数\\(f(x)\\) 的一个fourier展开 同理，随着位置的增大，位置编码不会重复 ","date":"2024-03-15","objectID":"/positional_embedding/:3:5","tags":["transformer","rope"],"title":"旋转位置编码","uri":"/positional_embedding/"},{"categories":null,"content":"代码实现 ","date":"2024-03-15","objectID":"/positional_embedding/:4:0","tags":["transformer","rope"],"title":"旋转位置编码","uri":"/positional_embedding/"},{"categories":null,"content":"trick1: 避开旋转矩阵的相乘 why？ 我们需要对每个\\(Q_{i}\\) 乘以不同的旋转矩阵，也就是 \\(QR=\\begin{pmatrix} Q_1 R(1\\Theta)\\\\ Q_2 R(2\\Theta)\\\\ \\ldots \\\\ Q_N R(N\\Theta)\\\\ \\end{pmatrix}\\) 而每个\\(R(i\\Theta)\\) 是一个稀疏矩阵，直接matmul代价太大 how? 假设是二维空间，把\\(Q\\) 拆分成两个列向量\\(U,V\\), 记录 \\(cos=\\begin{pmatrix}cos1\\theta \\\\ cos 2\\theta\\\\ \\ldots,\\\\ cos N\\theta \\end{pmatrix}, sin=\\begin{pmatrix}sin 1\\theta \\\\ sin 2\\theta\\\\ \\ldots,\\\\ sin N\\theta \\end{pmatrix}\\) 那么 \\(\\begin{aligned} QR\u0026=\\begin{pmatrix} u_1 cos 1\\theta-v_1 sin 1\\theta, u_1 sin 1\\theta + v_1 cos 1\\theta\\\\ u_2 cos 2\\theta-v_2 sin 2\\theta, u_2 sin 2\\theta + v_2 cos 2\\theta\\\\ \\ldots\\\\ u_N cos N\\theta-v_N sin N\\theta, u_N sin N \\theta + v_N cos N\\theta\\\\ \\end{pmatrix}\\\\ \u0026=(U * cos - V* sin, U*sin+V*cos) \\\\ \u0026= (U,V)cos +(-V, U) sin \\end{aligned}\\) 同样的，在高维空间，我们可以把\\(Q\\) 拆分成\\(D/2\\) 个列向量\\(U_1,V_1,U_2,V_2,\\ldots,U_{D/2},V_{D/2}\\) ","date":"2024-03-15","objectID":"/positional_embedding/:4:1","tags":["transformer","rope"],"title":"旋转位置编码","uri":"/positional_embedding/"},{"categories":null,"content":"trick2: 将整个空间分成两部分 不需要做严格紧密相连的二维子空间序列 第一个部分放的是每个子空间的第一维度， 第二部分放置的是每个子空间的第二维度 (x1,y1) 是一个子空间，(x2, y2)是一个子空间，(x3, y3)是一个子空间 before： [(x1,y1), (x2,y2), (x3,y3)] after： [(x1,x2,x3), (y1, y2, y3)] ","date":"2024-03-15","objectID":"/positional_embedding/:4:2","tags":["transformer","rope"],"title":"旋转位置编码","uri":"/positional_embedding/"},{"categories":null,"content":"code import torch import torch.nn as nn import math from torch.nn import functional as F class Rotator: \"\"\"根据hidden_dim，和position_ids 生成对应的旋转位置编码, 和论文中定义略有不同，一个个二维的子空间被 分割到了前后两部分，分别进行旋转，然后拼接起来 \"\"\" def __init__(self, D, position_ids): \"\"\" position_ids: [seq_len], D 和单个头的hidden_dim对应 \"\"\" base = 10000 d = D / 2 B = base ** (1/d) theta_base = 1.0 / (B ** (torch.arange(0, d))) # 几何级数序列 thetas = position_ids.outer(theta_base) # [seq_len, D/2] full_thetas = torch.cat((thetas, thetas), dim=-1) # [seq_len, D] self.cos = full_thetas.cos() self.sin = full_thetas.sin() def rotate(self, x): \"\"\" trick1 x: [bs, num_attention_heads, seq_len, D] q: [bs, num_attention_heads, seq_len, D] cos: [seq_len, D] [x,y] @ [[cos, sin], [-sin, cos]] = [x*cos-y*sin, ycos+x*sin] =[x,y]*cos+[-y, x]*sin \"\"\" return x * self.cos + Rotator.reverse_half(x) * self.sin @staticmethod def reverse_half(q): \"\"\" q: [bs, num_attention_heads, seq_len, D] trick2 \"\"\" x = q[..., : q.shape[-1] // 2] y = q[..., q.shape[-1] // 2:] return torch.cat((-y, x), dim=-1) class SelfAttentionWithRoPE(nn.Module): def __init__(self, config): super().__init__() self.H = config[\"n_head\"] self.F = config[\"hidden_dim\"] # F self.D = self.F // self.H # D # 一次把qkv 全部映射完成，对应W_Q, W_K, W_V self.qkv_proj = nn.Linear(self.F, 3 * self.F) # 最后的投影，对应于 $W_O$ self.out_proj = nn.Linear(self.F, self.F) def forward(self, x, position_ids): # position_ids: [seq_len] B, N, _ = x.size() q, k, v = self.qkv_proj(x).split(self.F, dim=-1) # matmul 只能在最后两个维度相乘，需要对NxD的矩阵相乘，做1,2维度的交换 k = k.view(B, N, self.H, self.D).transpose(1, 2) q = q.view(B, N, self.H, self.D).transpose(1, 2) v = v.view(B, N, self.H, self.D).transpose(1, 2) # 旋转位置编码 rotator = Rotator(self.D, position_ids) q = rotator.rotate(q) k = rotator.rotate(k) # 计算相似性 att = (q @ k.transpose(-2, -1)) * (1.0 / math.sqrt(k.size(-1))) att = F.softmax(att, dim=-1) y = att @ v # 多头拼接 y = y.transpose(1, 2).contiguous().view(B, N, self.F) y = self.out_proj(y) return y config = {\"n_head\": 2, \"hidden_dim\": 16, \"batch_size\": 3, \"seq_len\": 5} attn = SelfAttentionWithRoPE(config) x = torch.rand(config[\"batch_size\"], config[\"seq_len\"], config[\"hidden_dim\"]) position_ids = torch.arange(config[\"seq_len\"]) y = attn(x, position_ids) ","date":"2024-03-15","objectID":"/positional_embedding/:4:3","tags":["transformer","rope"],"title":"旋转位置编码","uri":"/positional_embedding/"},{"categories":null,"content":"总结 RoPE的motivation： 希望相似性只依赖于向量本身和其相对位置的距离 通过对\\(Q_i,K_i\\) 施加 $R(iΘ)$变换做到 \\begin{equation*} \\begin{split} Q_{i}\u0026 = X_{i} W_{Q} R(i\\Theta) \\\\ K_{j}\u0026 = X_j W_{K} R(j\\Theta)\\\\ Q_{i}K_j^T \u0026=X_{i}W_QR(i\\Theta)R(j\\Theta)^{T}W_K^{T}X_{j}^{T}\\\\ \u0026=X_{i}W_QR(i\\Theta)R(-j\\Theta)W_K^{T}X_{j}^{T}\\\\ \u0026=X_{i}W_QR((i-j)\\Theta)W_K^{T}X_{j}^{T}\\\\ \u0026=g(X_i,X_j,i-j)\\\\ \\end{split} \\end{equation*} RoPE是什么？ 把原空间切分成为一个个正交的二维子空间，在上面做独立的旋转。 RoPE 结构 有\\(d\\) 个正交的二维子空间 \\(\\mathcal{X}_1, \\mathcal{X}_2, \\dots, \\mathcal{X}_{d}\\) 每个子空间\\(\\mathcal{X}_{k}\\) 对应一个基础角度和基础矩阵 \\(\\theta_{k}, R(\\theta_{k})\\) 对于每个位置\\(i\\), 对应一个角度序列和矩阵序列 \\(i\\Theta, R(i\\Theta)\\) \\(\\Theta\\) \\(\\theta_1\\) \\(\\theta_2\\) \\(\\theta_3\\) \\(\\ldots\\) \\(\\theta_{d}\\) \\(R(\\Theta)\\) \\(R(\\theta_1)\\) \\(R(\\theta_{2})\\) \\(R(\\theta_3)\\) \\(\\ldots\\) \\(R(\\theta_{d})\\) \\(i\\Theta\\) \\(i\\theta_1\\) \\(i\\theta_{2}\\) \\(i\\theta_3\\) \\(\\ldots\\) \\(i\\theta_{d}\\) 绝对位置编码和RoPE 有相似的结构 ","date":"2024-03-15","objectID":"/positional_embedding/:4:4","tags":["transformer","rope"],"title":"旋转位置编码","uri":"/positional_embedding/"},{"categories":null,"content":"参考论文 Su, Jianlin, Yu Lu, Shengfeng Pan, Ahmed Murtadha, Bo Wen, and Yunfeng Liu. 2022. “RoFormer: Enhanced Transformer with Rotary Position Embedding.” arXiv. https://arxiv.org/abs/2104.09864. Vaswani, Ashish, Noam Shazeer, Niki Parmar, Jakob Uszkoreit, Llion Jones, Aidan N. Gomez, Lukasz Kaiser, and Illia Polosukhin. 2023. “Attention Is All You Need.” arXiv. https://arxiv.org/abs/1706.03762. ","date":"2024-03-15","objectID":"/positional_embedding/:5:0","tags":["transformer","rope"],"title":"旋转位置编码","uri":"/positional_embedding/"},{"categories":null,"content":"Whole hugo blog in plain text!","date":"2024-03-17","objectID":"/configure_emacs/","tags":["emacs"],"title":"Emacs配置文件","uri":"/configure_emacs/"},{"categories":null,"content":"基础配置 ","date":"2024-03-17","objectID":"/configure_emacs/:1:0","tags":["emacs"],"title":"Emacs配置文件","uri":"/configure_emacs/"},{"categories":null,"content":"straight (defvar bootstrap-version) (let ((bootstrap-file (expand-file-name \"straight/repos/straight.el/bootstrap.el\" user-emacs-directory)) (bootstrap-version 5)) (unless (file-exists-p bootstrap-file) (with-current-buffer (url-retrieve-synchronously \"https://raw.githubusercontent.com/raxod502/straight.el/develop/install.el\" 'silent 'inhibit-cookies) (goto-char (point-max)) (eval-print-last-sexp))) (load bootstrap-file nil 'nomessage)) ","date":"2024-03-17","objectID":"/configure_emacs/:1:1","tags":["emacs"],"title":"Emacs配置文件","uri":"/configure_emacs/"},{"categories":null,"content":"use package (require 'package) (add-to-list 'package-archives '(\"gnu\" . \"https://elpa.gnu.org/packages/\")) (add-to-list 'package-archives '(\"melpa\" . \"https://melpa.org/packages/\")) (package-initialize) (unless (package-installed-p 'use-package) (package-refresh-contents) (package-install 'use-package)) (eval-and-compile (setq use-package-always-ensure t use-package-expand-minimally t)) ","date":"2024-03-17","objectID":"/configure_emacs/:1:2","tags":["emacs"],"title":"Emacs配置文件","uri":"/configure_emacs/"},{"categories":null,"content":"dired (global-set-key (kbd \"C-x C-j\") 'dired-jump) (require 'dired-x) (setq dired-omit-files (concat dired-omit-files \"\\\\|^\\\\.DS_Store$\" \"\\\\|^\\\\..+$\" \"\\\\|__pycache__\" \"\\\\|.*\\\\.pyc$\")) (add-hook 'dired-mode-hook 'dired-omit-mode) (use-package dired-sidebar :bind ((\"C-x C-n\" . dired-sidebar-toggle-sidebar)) :ensure t :commands (dired-sidebar-toggle-sidebar) :init (add-hook 'dired-sidebar-mode-hook (lambda () (unless (file-remote-p default-directory) (auto-revert-mode)))) :config (push 'toggle-window-split dired-sidebar-toggle-hidden-commands) (push 'rotate-windows dired-sidebar-toggle-hidden-commands) (setq dired-sidebar-subtree-line-prefix \"__\") (setq dired-sidebar-theme 'vscode) (setq dired-sidebar-use-term-integration t) (setq dired-sidebar-use-custom-font t)) (use-package dired-subtree :ensure t :defer t :bind (:map dired-mode-map (\"TAB\" . dired-subtree-cycle))) (use-package dired-collapse :ensure t :config (add-hook 'dired-mode-hook 'dired-collapse-mode) ) (use-package dired-rainbow :config (progn (dired-rainbow-define-chmod directory \"#6cb2eb\" \"d.*\") (dired-rainbow-define html \"#eb5286\" (\"css\" \"less\" \"sass\" \"scss\" \"htm\" \"html\" \"jhtm\" \"mht\" \"eml\" \"mustache\" \"xhtml\")) (dired-rainbow-define xml \"#f2d024\" (\"xml\" \"xsd\" \"xsl\" \"xslt\" \"wsdl\" \"bib\" \"json\" \"msg\" \"pgn\" \"rss\" \"yaml\" \"yml\" \"rdata\")) (dired-rainbow-define document \"#9561e2\" (\"docm\" \"doc\" \"docx\" \"odb\" \"odt\" \"pdb\" \"pdf\" \"ps\" \"rtf\" \"djvu\" \"epub\" \"odp\" \"ppt\" \"pptx\")) (dired-rainbow-define markdown \"#ffed4a\" (\"org\" \"etx\" \"info\" \"markdown\" \"md\" \"mkd\" \"nfo\" \"pod\" \"rst\" \"tex\" \"textfile\" \"txt\")) (dired-rainbow-define database \"#6574cd\" (\"xlsx\" \"xls\" \"csv\" \"accdb\" \"db\" \"mdb\" \"sqlite\" \"nc\")) (dired-rainbow-define media \"#de751f\" (\"mp3\" \"mp4\" \"MP3\" \"MP4\" \"avi\" \"mpeg\" \"mpg\" \"flv\" \"ogg\" \"mov\" \"mid\" \"midi\" \"wav\" \"aiff\" \"flac\")) (dired-rainbow-define image \"#f66d9b\" (\"tiff\" \"tif\" \"cdr\" \"gif\" \"ico\" \"jpeg\" \"jpg\" \"png\" \"psd\" \"eps\" \"svg\")) (dired-rainbow-define log \"#c17d11\" (\"log\")) (dired-rainbow-define shell \"#f6993f\" (\"awk\" \"bash\" \"bat\" \"sed\" \"sh\" \"zsh\" \"vim\")) (dired-rainbow-define interpreted \"#38c172\" (\"py\" \"ipynb\" \"rb\" \"pl\" \"t\" \"msql\" \"mysql\" \"pgsql\" \"sql\" \"r\" \"clj\" \"cljs\" \"scala\" \"js\")) (dired-rainbow-define compiled \"#4dc0b5\" (\"asm\" \"cl\" \"lisp\" \"el\" \"c\" \"h\" \"c++\" \"h++\" \"hpp\" \"hxx\" \"m\" \"cc\" \"cs\" \"cp\" \"cpp\" \"go\" \"f\" \"for\" \"ftn\" \"f90\" \"f95\" \"f03\" \"f08\" \"s\" \"rs\" \"hi\" \"hs\" \"pyc\" \".java\")) (dired-rainbow-define executable \"#8cc4ff\" (\"exe\" \"msi\")) (dired-rainbow-define compressed \"#51d88a\" (\"7z\" \"zip\" \"bz2\" \"tgz\" \"txz\" \"gz\" \"xz\" \"z\" \"Z\" \"jar\" \"war\" \"ear\" \"rar\" \"sar\" \"xpi\" \"apk\" \"xz\" \"tar\")) (dired-rainbow-define packaged \"#faad63\" (\"deb\" \"rpm\" \"apk\" \"jad\" \"jar\" \"cab\" \"pak\" \"pk3\" \"vdf\" \"vpk\" \"bsp\")) (dired-rainbow-define encrypted \"#ffed4a\" (\"gpg\" \"pgp\" \"asc\" \"bfe\" \"enc\" \"signature\" \"sig\" \"p12\" \"pem\")) (dired-rainbow-define fonts \"#6cb2eb\" (\"afm\" \"fon\" \"fnt\" \"pfb\" \"pfm\" \"ttf\" \"otf\")) (dired-rainbow-define partition \"#e3342f\" (\"dmg\" \"iso\" \"bin\" \"nrg\" \"qcow\" \"toast\" \"vcd\" \"vmdk\" \"bak\")) (dired-rainbow-define vc \"#0074d9\" (\"git\" \"gitignore\" \"gitattributes\" \"gitmodules\")) (dired-rainbow-define-chmod executable-unix \"#38c172\" \"-.*x.*\") )) (use-package dired-filter :ensure t) (use-package dired-narrow :ensure t :bind (:map dired-mode-map (\",\" . dired-narrow)) ) (use-package dired-ranger :ensure t) ","date":"2024-03-17","objectID":"/configure_emacs/:1:3","tags":["emacs"],"title":"Emacs配置文件","uri":"/configure_emacs/"},{"categories":null,"content":"other (setq make-backup-files nil) (setq ns-pop-up-frames nil) ;; (global-set-key [remap goto-line] 'goto-line-preview) ;; (setq eshell-last-dir-ring-size 500) (add-hook 'sh-mode-hook 'flycheck-mode) (if (display-graphic-p) (progn (scroll-bar-mode -1) (load-theme 'misterioso) ) (progn (menu-bar-mode -1) ;; (toggle-scroll-bar -1) (tool-bar-mode -1) ;(load-theme 'zenburn) ) ) ;; for mac (setq mac-command-modifier 'meta) (setq mac-option-modifier 'super) (setq ns-function-modifier 'hyper) ; make Fn key do Hyper (setq abbrev-file-name \"~/.emacs.d/personal/.abbrev_defs\") ;; 缺省的定义缩写的文件。 (setq my/savefile-dir \"~/.emacs.d/personal/\") (setq bookmark-default-file (expand-file-name \"bookmarks\" my/savefile-dir)) ;; 缺省书签文件的路径及文件名。 ;; save recent files (require 'recentf) (setq recentf-save-file (expand-file-name \"recentf\" my/savefile-dir) recentf-max-saved-items 500 recentf-max-menu-items 15 recentf-auto-cleanup 'never) (global-font-lock-mode 1) ; 开启语法高亮。 (auto-compression-mode 1) ; 打开压缩文件时自动解压缩。 (column-number-mode 1) ; 显示列号。 (blink-cursor-mode -1) ; 光标不要闪烁。 ;; (display-time-mode 1) ; 显示时间。 (show-paren-mode 1) ; 高亮显示匹配的括号。 (icomplete-mode 1) ; 给出用 M-x foo-bar-COMMAND 输入命令的提示。 (setq select-enable-clipboard t) ;用来和系统共享剪贴板 (setq confirm-kill-emacs 'yes-or-no-p) (transient-mark-mode t) (set-face-attribute 'region nil :background \"#666\" :foreground \"#ffffff\") ;; 可以让选择的区域高亮 (line-number-mode t) (setq-default kill-whole-line t) ;; 在行首 C-k 时，同时删除该行。 (fset 'yes-or-no-p 'y-or-n-p) ;;改变 Emacs 固执的要你回答 yes 的行为。按y或空格键表示yes,n表示no。 (setq auto-image-file-mode t) ;; 系统相关 (set-frame-font \"Menlo-16\" nil t) (cond ((equal system-type 'gnu/linux) (set-frame-font \"Monospace-19\")) ((equal system-type 'darwin) (tool-bar-mode -1) (set-frame-font \"Menlo-16\") (add-to-list 'default-frame-alist '(font . \"Menlo-16\")) ;; (set-fontset-font ;; (frame-parameter nil 'font) ;; 'han ;; (font-spec :family \"Hiragino Sans GB\" )) )) (setq auto-save-default nil) (setq whitespace-style '(tabs trailing lines tab-mark)) (use-package exec-path-from-shell :ensure t :config (when (memq window-system '(mac ns x)) (exec-path-from-shell-initialize)) ) ;; (provide 'basic_conf) (add-hook 'dired-after-readin-hook 'hl-line-mode) (require 'uniquify) (setq uniquify-buffer-name-style 'reverse) (setq uniquify-separator \"/\") (setq uniquify-after-kill-buffer-p t) ; rename after killing uniquified (setq uniquify-ignore-buffers-re \"^\\\\*\") ; don't muck with special buffers (when (display-graphic-p) (use-package csv-mode :ensure t :config (add-hook 'csv-mode-hook 'csv-align-mode)) ;(use-package vterm ; :ensure t) ;(use-package multi-vterm ; :ensure t) ) (add-to-list 'package-archives '(\"melpa-stable\" . \"https://stable.melpa.org/packages/\") t) ","date":"2024-03-17","objectID":"/configure_emacs/:1:4","tags":["emacs"],"title":"Emacs配置文件","uri":"/configure_emacs/"},{"categories":null,"content":"doc and pdf (use-package pdf-tools :ensure t :config (pdf-tools-install) ;; automatically open pdfs with pdf-tools (setq-default pdf-view-display-size 'fit-page) (add-to-list 'auto-mode-alist '(\"\\\\.pdf\\\\'\" . pdf-view-mode))) (add-hook 'pdf-view-mode-hook (lambda () (display-line-numbers-mode -1))) (use-package org-noter :ensure t ) (use-package devdocs :ensure t :config (global-set-key (kbd \"C-h D\") 'devdocs-lookup) ) (use-package devdocs-browser :ensure t) ","date":"2024-03-17","objectID":"/configure_emacs/:1:5","tags":["emacs"],"title":"Emacs配置文件","uri":"/configure_emacs/"},{"categories":null,"content":"emacs server ;; emacs server, client 可以在终端使用 /Applications/Emacs\\ 2.app/Contents/MacOS/bin/emacsclient ifuns.el \u0026来启动 (when (display-graphic-p) (server-start) ) ","date":"2024-03-17","objectID":"/configure_emacs/:1:6","tags":["emacs"],"title":"Emacs配置文件","uri":"/configure_emacs/"},{"categories":null,"content":"terminal (use-package vterm :when (memq window-system '(mac ns x pgtk)) :bind (:map vterm-mode-map (\"C-y\" . vterm-yank) (\"M-y\" . vterm-yank-pop) (\"C-k\" . vterm-send-C-k-and-kill)) :init (setq vterm-shell \"zsh\") :config (setq vterm-always-compile-module t) (setq vterm-buffer-name-string \"vterm %s\") (defun vterm-send-C-k-and-kill () \"Send `C-k' to libvterm, and put content in kill-ring.\" (interactive) (kill-ring-save (point) (vterm-end-of-line)) (vterm-send-key \"k\" nil nil t))) (use-package vterm-toggle :when (memq window-system '(mac ns x pgtk)) ;; :bind (([f8] . vterm-toggle) ;; ([f9] . vterm-compile) ;; :map vterm-mode-map ;; ([f8] . vterm-toggle) ;; ([(control return)] . vterm-toggle-insert-cd)) :config (setq vterm-toggle-cd-auto-create-buffer nil) (defvar vterm-compile-buffer nil) (defun vterm-compile () \"Compile the program including the current buffer in `vterm'.\" (interactive) (setq compile-command (compilation-read-command compile-command)) (let ((vterm-toggle-use-dedicated-buffer t) (vterm-toggle--vterm-dedicated-buffer (if (vterm-toggle--get-window) (vterm-toggle-hide) vterm-compile-buffer))) (with-current-buffer (vterm-toggle-cd) (setq vterm-compile-buffer (current-buffer)) (rename-buffer \"*vterm compilation*\") (compilation-shell-minor-mode 1) (vterm-send-M-w) (vterm-send-string compile-command t) (vterm-send-return))))) ","date":"2024-03-17","objectID":"/configure_emacs/:1:7","tags":["emacs"],"title":"Emacs配置文件","uri":"/configure_emacs/"},{"categories":null,"content":"项目管理 ","date":"2024-03-17","objectID":"/configure_emacs/:2:0","tags":["emacs"],"title":"Emacs配置文件","uri":"/configure_emacs/"},{"categories":null,"content":"magit (use-package magit :ensure t ) (use-package magit-delta :hook (magit-mode . magit-delta-mode)) ","date":"2024-03-17","objectID":"/configure_emacs/:2:1","tags":["emacs"],"title":"Emacs配置文件","uri":"/configure_emacs/"},{"categories":null,"content":"edit ","date":"2024-03-17","objectID":"/configure_emacs/:3:0","tags":["emacs"],"title":"Emacs配置文件","uri":"/configure_emacs/"},{"categories":null,"content":"光标移动 (use-package smartscan :ensure t :config (add-hook 'prog-mode-hook 'smartscan-mode) (add-hook 'org-mode-hook 'smartscan-mode) (add-hook 'dired-mode-hook 'smartscan-mode) ) ;; enable a more powerful jump back function from ace jump mode (use-package ace-jump-mode :ensure t :config (define-key global-map (kbd \"C-c SPC\") 'ace-jump-mode) (autoload 'ace-jump-mode-pop-mark \"ace-jump-mode\" \"Ace jump back:-)\" t) (eval-after-load \"ace-jump-mode\" '(ace-jump-mode-enable-mark-sync)) ) (use-package ace-pinyin :ensure t :config (setq ace-pinyin-use-avy nil) (ace-pinyin-global-mode +1) (global-set-key (kbd \"s-i pj\") 'ace-pinyin-jump-char) ) ","date":"2024-03-17","objectID":"/configure_emacs/:3:1","tags":["emacs"],"title":"Emacs配置文件","uri":"/configure_emacs/"},{"categories":null,"content":"选择和拷贝 (use-package expand-region :bind (\"C-=\" . er/expand-region)) ;; alt-w b 拷贝当前文件的路径 (use-package easy-kill :ensure t :config (global-set-key [remap kill-ring-save] 'easy-kill) (global-set-key [remap mark-sexp] 'easy-mark) ) ","date":"2024-03-17","objectID":"/configure_emacs/:3:2","tags":["emacs"],"title":"Emacs配置文件","uri":"/configure_emacs/"},{"categories":null,"content":"bookmark bm (use-package bm :ensure t :demand t :init (setq bm-restore-repository-on-load t) :config (setq bm-cycle-all-buffers t) (setq bm-repository-file \"~/.emacs.d/bm-repository\") (setq-default bm-buffer-persistence t) (add-hook 'after-init-hook 'bm-repository-load) (add-hook 'kill-buffer-hook #'bm-buffer-save) (add-hook 'kill-emacs-hook #'(lambda nil (bm-buffer-save-all) (bm-repository-save))) (add-hook 'after-save-hook #'bm-buffer-save) (add-hook 'find-file-hooks #'bm-buffer-restore) (add-hook 'after-revert-hook #'bm-buffer-restore) (add-hook 'vc-before-checkin-hook #'bm-buffer-save) (setq bm-marker 'bm-marker-right) (global-set-key (kbd \"\u003cleft-fringe\u003e \u003cM-mouse-1\u003e\") 'bm-toggle-mouse) (global-set-key (kbd \"s-i bn\") 'bm-next) (global-set-key (kbd \"s-i bp\") 'bm-previous) (global-set-key (kbd \"s-i bt\") 'bm-toggle) (global-set-key (kbd \"s-i bl\") 'bm-show-all) ) bookmark-int-project (use-package bookmark-in-project :ensure t :commands (bookmark-in-project-jump bookmark-in-project-jump-next b bookmark-in-project-jump-previous bookmark-in-project-delete-all) :bind ( ;; (\"s-i pbl\" . bookmark-in-project-jump) (\"s-i pbn\" . bookmark-in-project-jump-next) (\"s-i pbt\" . bookmark-in-project-toggle) (\"s-i pbp\" . bookmark-in-project-jump-previous) (\"s-i pbd\" . bookmark-in-project-delete-all) )) (load-library \"bookmark-in-project\") (defun my/bookmark-in-project-jump () \"Jump to a bookmark in the current project.\" (interactive) (bookmark-maybe-load-default-file) (bookmark-in-project--jump-impl #'bookmark-jump)) (global-set-key (kbd \"s-i pbl\") 'my/bookmark-in-project-jump) ","date":"2024-03-17","objectID":"/configure_emacs/:3:3","tags":["emacs"],"title":"Emacs配置文件","uri":"/configure_emacs/"},{"categories":null,"content":"配对的括号编辑 change-inner (use-package change-inner :ensure t :config :bind ((\"s-i ci\" . change-inner) (\"s-i co\" . change-outer) ) ) embrace ;; 删除修改配对的括号，这里的括号包括：(),[],{},\u003c\u003e,单引号，双引号 (use-package embrace :ensure t :bind ((\"s-i ,\" . embrace-commander)) ) ","date":"2024-03-17","objectID":"/configure_emacs/:3:4","tags":["emacs"],"title":"Emacs配置文件","uri":"/configure_emacs/"},{"categories":null,"content":"basic (when (display-graphic-p) ;; Do any keybindings and theme setup here (use-package gnuplot :ensure t) (use-package gnuplot-mode :ensure t) (use-package helm-chrome :ensure t) (use-package diminish :ensure t) (use-package visual-regexp :ensure t) (use-package visual-regexp-steroids :ensure t :config (define-key global-map (kbd \"C-c q\") 'vr/query-replace) ) ;; for forge ;(setq auth-sources '(\"~/.authinfo\")) ;(use-package forge ; :ensure t ; ) ;(with-eval-after-load 'magit ; (require 'forge)) ;(with-eval-after-load 'forge ; (add-to-list 'forge-alist ; '(\"gitlab.mobvista.com\" ; \"gitlab.mobvista.com/api/v4\" ; \"gitlab.mobvista.com\" ; forge-gitlab-repository))) ;;google this (use-package google-this :ensure t :config (google-this-mode 1) (global-set-key (kbd \"C-c g\") 'google-this-mode-submap) ) ;; youtube (use-package helm-youtube :ensure t :config (setq helm-youtube-key \"AIzaSyAQB8odOXYv46YR-x0Dk7BZbVTnWVYL4oM\") (define-key global-map (kbd \"C-c y\") 'helm-youtube) ) (use-package good-scroll :ensure t :config (good-scroll-mode -1) ) (use-package beacon :ensure t :config (beacon-mode -1) ) (use-package key-chord :ensure t :config (key-chord-mode 1) (key-chord-define-global \"hj\" 'undo) ) (use-package which-key :ensure t :config (which-key-mode) ) (use-package zop-to-char :ensure t :config (global-set-key (kbd \"M-z\") 'zop-up-to-char) (global-set-key (kbd \"M-Z\") 'zop-to-char) ) (setq package-check-signature nil) (use-package undo-tree :ensure t :config (undo-tree-mode) (setq undo-tree-history-directory-alist `((\".*\" . ,temporary-file-directory))) (setq undo-tree-auto-save-history t) (global-undo-tree-mode) ) (use-package crux :ensure t) (use-package anzu :ensure t :config (global-anzu-mode) (global-set-key (kbd \"M-%\") 'anzu-query-replace) (global-set-key (kbd \"C-M-%\") 'anzu-query-replace-regexp) ) (use-package zenburn-theme :ensure t ;; :config ;; (load-theme 'zenburn t) ) ;; (use-package openwith ;; :ensure t ;; :config ;; (when (require 'openwith nil 'noerror) ;; (setq openwith-associations ;; (list ;; (list (openwith-make-extension-regexp ;; '(\"doc\" \"docx\" \"xls\" \"ppt\" \"pptx\" \"docx\" \"pdf\")) ;; \"open\" ;; '(file)) ;; (list (openwith-make-extension-regexp ;; '(\"pdf\" \"ps\" \"ps.gz\" \"dvi\")) ;; \"open\" ;; '(file)) ;; )) ;; (openwith-mode 1)) ;; ) ) (use-package browse-kill-ring :disabled :ensure t :config (browse-kill-ring-default-keybindings) (global-set-key (kbd \"s-y\") 'browse-kill-ring) ;; 有了helm-show-kill-ring 就够用了 ) (use-package transpose-frame :ensure t ) (display-line-numbers-mode) (use-package which-key :config (which-key-mode)) ;; ace-pinyin and evil-numbers 可能不兼容copilot ;; (use-package evil-numbers ;; :ensure t ;; :config ;; (global-set-key (kbd \"C-c +\") 'evil-numbers/inc-at-pt) ;; (global-set-key (kbd \"C-c -\") 'evil-numbers/dec-at-pt) ;; (global-set-key (kbd \"C-c C-+\") 'evil-numbers/inc-at-pt-incremental) ;; (global-set-key (kbd \"C-c C--\") 'evil-numbers/dec-at-pt-incremental) ;; ) ","date":"2024-03-17","objectID":"/configure_emacs/:3:5","tags":["emacs"],"title":"Emacs配置文件","uri":"/configure_emacs/"},{"categories":null,"content":"appearance ","date":"2024-03-17","objectID":"/configure_emacs/:4:0","tags":["emacs"],"title":"Emacs配置文件","uri":"/configure_emacs/"},{"categories":null,"content":"theme doom-themes (use-package doom-themes :ensure t :config ;; Global settings (defaults) (setq doom-themes-enable-bold t ; if nil, bold is universally disabled doom-themes-enable-italic t) ; if nil, italics is universally disabled ;; (load-theme 'doom-zenburn t) ;; (load-theme 'doom-snazzy t) (load-theme 'doom-zenburn t) (doom-themes-visual-bell-config) (doom-themes-neotree-config) (setq doom-themes-treemacs-theme \"doom-atom\") ; use \"doom-colors\" for less minimal icon theme (doom-themes-treemacs-config) (doom-themes-org-config)) helm-themes (use-package helm-themes :ensure t ) ","date":"2024-03-17","objectID":"/configure_emacs/:4:1","tags":["emacs"],"title":"Emacs配置文件","uri":"/configure_emacs/"},{"categories":null,"content":"window (use-package ace-window :ensure t :bind ((\"C-x o\" . ace-window))) (use-package workgroups2 :ensure t :init (setq wg-prefix-key \"C-c w\") (setq wg-session-file \"~/.emacs.d/.emacs_workgroups\") :config (workgroups-mode 1)) (winner-mode 1) ","date":"2024-03-17","objectID":"/configure_emacs/:4:2","tags":["emacs"],"title":"Emacs配置文件","uri":"/configure_emacs/"},{"categories":null,"content":"rainbow (use-package rainbow-delimiters :ensure t :config (add-hook 'prog-mode-hook 'rainbow-delimiters-mode) (add-hook 'org-mode-hook 'rainbow-delimiters-mode) ) ","date":"2024-03-17","objectID":"/configure_emacs/:4:3","tags":["emacs"],"title":"Emacs配置文件","uri":"/configure_emacs/"},{"categories":null,"content":"doom-modeline (prefer-coding-system 'utf-8) (set-default-coding-systems 'utf-8) (set-terminal-coding-system 'utf-8) (set-keyboard-coding-system 'utf-8) (setq default-buffer-file-coding-system 'utf-8) (setq system-time-locale \"zh_CN.UTF-8\") (when (display-graphic-p) ;; Do any keybindings and theme setup here (setenv \"JAVA_HOME\" \"/Library/Java/JavaVirtualMachines/adoptopenjdk-8.jdk/Contents/Home\") (use-package all-the-icons :ensure t) (use-package all-the-icons-ivy-rich :ensure t :config (all-the-icons-ivy-rich-mode 1) ) (use-package all-the-icons-dired :ensure t :config (add-hook 'dired-mode-hook 'all-the-icons-dired-mode) ) (use-package doom-modeline :ensure t :hook (after-init . doom-modeline-mode) :config (setq doom-modeline-env-version t) (setq doom-modeline-env-enable-python t) (setq doom-modeline-env-enable-ruby t) (setq doom-modeline-env-enable-perl t) (setq doom-modeline-env-enable-go t) (setq doom-modeline-env-enable-elixir t) (setq doom-modeline-env-enable-rust t) (setq doom-modeline-buffer-encoding t) (setq doom-modeline-workspace-name t) (setq doom-modeline-buffer-file-name-style 'buffer-name) :custom-face (mode-line ((t (:height 1.0)))) (mode-line-inactive ((t (:height 1.0)))) :custom (doom-modeline-height 18) (doom-modeline-bar-width 10) (doom-modeline-lsp t) (doom-modeline-github t) (doom-modeline-mu4e nil) (doom-modeline-irc t) (doom-modeline-buffer-encoding t) (doom-modeline-battery t) ;; (doom-modeline-minor-modes t) ;; (doom-modeline-persp-name nil) (doom-modeline-major-mode-icon t) ) (with-eval-after-load 'sr-speedbar (add-hook 'speedbar-visiting-file-hook #'(lambda () (select-window (next-window))) t)) ;; (use-package neotree ;; :ensure t ;; ) ) ","date":"2024-03-17","objectID":"/configure_emacs/:4:4","tags":["emacs"],"title":"Emacs配置文件","uri":"/configure_emacs/"},{"categories":null,"content":"program ","date":"2024-03-17","objectID":"/configure_emacs/:5:0","tags":["emacs"],"title":"Emacs配置文件","uri":"/configure_emacs/"},{"categories":null,"content":"appearance 边栏 (when (display-graphic-p) (use-package treemacs :ensure t :bind (:map global-map ([f8] . treemacs-select-window) ) ) ) code folding ;;hide and show (add-hook 'emacs-lisp-mode-hook 'hs-minor-mode) (add-hook 'python-mode-hook 'hs-minor-mode) (add-hook 'go-mode 'hs-minor-mode) (add-hook 'c++-mode 'hs-minor-mode) (add-hook 'prog-mode-hook 'outline-minor-mode) (add-hook 'prog-mode-hook 'hs-minor-mode) ;; (use-package bicycle ;; :bind (:map outline-minor-mode-map ;; ([C-tab] . bicycle-cycle) ;; ([S-tab] . bicycle-cycle-global)) ;; ) (use-package yafolding :bind (:map yafolding-mode-map ([C-tab] . yafolding-toggle-element) ([S-tab] . yafolding-toggle-all)) :config (add-hook 'prog-mode-hook 'yafolding-mode) ) (use-package outline-minor-faces :after outline :config (add-hook 'outline-minor-mode-hook #'outline-minor-faces-mode)) ","date":"2024-03-17","objectID":"/configure_emacs/:5:1","tags":["emacs"],"title":"Emacs配置文件","uri":"/configure_emacs/"},{"categories":null,"content":"documentation (use-package dash-at-point :ensure t :config (global-set-key (kbd \"s-i dp\") 'dash-at-point) (global-set-key (kbd \"s-i dw\") 'dash-at-point-with-docset) ) ","date":"2024-03-17","objectID":"/configure_emacs/:5:2","tags":["emacs"],"title":"Emacs配置文件","uri":"/configure_emacs/"},{"categories":null,"content":"补全 (use-package company :ensure t :hook (scala-mode . company-mode) :config (add-hook 'after-init-hook 'global-company-mode) (define-key company-search-map (kbd \"C-n\") 'company-select-next) (define-key company-search-map (kbd \"C-p\") 'company-select-previous) (define-key company-active-map (kbd \"M-\u003c\") 'company-select-first) (define-key company-active-map (kbd \"M-\u003e\") 'company-select-last) (setq lsp-completion-provider :capf) :custom (company-minimum-prefix-length 3) (company-idle-delay 0.0)) (use-package copilot :straight (:host github :repo \"zerolfx/copilot.el\" :files (\"dist\" \"*.el\")) :ensure t :config (setq copilot-network-proxy '(:host \"127.0.0.1\" :port 61491)) ) (add-hook 'prog-mode-hook 'copilot-mode) (with-eval-after-load 'company (delq 'company-preview-if-just-one-frontend company-frontends)) (define-key copilot-completion-map (kbd \"\u003ctab\u003e\") 'copilot-accept-completion) (define-key copilot-completion-map (kbd \"TAB\") 'copilot-accept-completion) ","date":"2024-03-17","objectID":"/configure_emacs/:5:3","tags":["emacs"],"title":"Emacs配置文件","uri":"/configure_emacs/"},{"categories":null,"content":"helm ;; helm (use-package helm :ensure t :config (setq helm-locate-fuzzy-match nil) (setq helm-locate-command \"mdfind -name %s %s\") (setq locate-command \"mdfind\") ;; (setq helm-follow-mode-persistent t) (global-set-key (kbd \"C-c h\") 'helm-command-prefix) (global-set-key (kbd \"M-x\") 'helm-M-x) (global-set-key (kbd \"M-y\") 'helm-show-kill-ring) (global-set-key (kbd \"C-x b\") 'helm-mini) (global-set-key (kbd \"C-x C-b\") 'helm-buffers-list) (global-set-key (kbd \"C-x C-f\") 'helm-find-files) (global-set-key (kbd \"C-x r b\") #'helm-filtered-bookmarks) (set-face-attribute 'helm-selection nil :background \"lime green\" :foreground \"black\") (setq helm-split-window-in-side-p t ; open helm buffer inside current window, ; not occupy whole other window helm-move-to-line-cycle-in-source t ; move to end or beginning of source when ; reaching top or bottom of source. helm-ff-search-library-in-sexp t ; search for library in `require' and `declare-function' sexp. helm-scroll-amount 8 ; scroll 8 lines other window using M-\u003cnext\u003e/M-\u003cprior\u003e helm-ff-file-name-history-use-recentf t ;; Allow fuzzy matches in helm semantic helm-semantic-fuzzy-match t helm-imenu-fuzzy-match t) ;; Have helm automaticaly resize the window (helm-autoresize-mode 1) (setq rtags-use-helm t) (setq helm-buffer-max-length nil) ) (use-package helm-projectile :ensure t :config (helm-projectile-on) (setq projectile-completion-system 'helm) ) (use-package helm-swoop :ensure t :config (global-set-key (kbd \"M-i\") 'helm-swoop) (global-set-key (kbd \"C-c M-i\") 'helm-multi-swoop) (global-set-key (kbd \"C-x M-i\") 'helm-multi-swoop-all) ;; When doing isearch, hand the word over to helm-swoop (define-key isearch-mode-map (kbd \"M-i\") 'helm-swoop-from-isearch) ;; From helm-swoop to helm-multi-swoop-all (define-key helm-swoop-map (kbd \"M-i\") 'helm-multi-swoop-all-from-helm-swoop) ;; When doing evil-search, hand the word over to helm-swoop ;; (define-key evil-motion-state-map (kbd \"M-i\") 'helm-swoop-from-evil-search) ;; Instead of helm-multi-swoop-all, you can also use helm-multi-swoop-current-mode (define-key helm-swoop-map (kbd \"M-m\") 'helm-multi-swoop-current-mode-from-helm-swoop) ;; Move up and down like isearch (define-key helm-swoop-map (kbd \"C-r\") 'helm-previous-line) (define-key helm-swoop-map (kbd \"C-s\") 'helm-next-line) (define-key helm-multi-swoop-map (kbd \"C-r\") 'helm-previous-line) (define-key helm-multi-swoop-map (kbd \"C-s\") 'helm-next-line) ) (use-package helm-ag :ensure t) (defun my-helm-ag-thing-at-point () \"Search the symbol at point with `helm-ag'.\" (interactive) (let ((helm-ag-insert-at-point 'symbol)) (helm-projectile-ag) ;; (helm-do-ag-project-root) )) (global-set-key (kbd \"M-I\") 'my-helm-ag-thing-at-point) (use-package helm-ls-git :ensure t ) (use-package helm-ctest :ensure t ) (use-package helm-flycheck :ensure t :config (eval-after-load 'flycheck '(define-key flycheck-mode-map (kbd \"C-c ! h\") 'helm-flycheck)) ) ;; (require 'swiper-helm) (use-package helm-bm :ensure t ) ","date":"2024-03-17","objectID":"/configure_emacs/:5:4","tags":["emacs"],"title":"Emacs配置文件","uri":"/configure_emacs/"},{"categories":null,"content":"lsp ;; lsp related (use-package lsp-mode :ensure t :hook (scala-mode . lsp) (lsp-mode . lsp-lens-mode) (python-mode . lsp) (c++-mode . lsp) (sh-mode . lsp-deferred) (yaml-mode . lsp) :init (setq lsp-bash-server-command '(\"bash-language-server\" \"start\")) :config ;; Uncomment following section if you would like to tune lsp-mode performance according to ;; https://emacs-lsp.github.io/lsp-mode/page/performance/ ;; (setq gc-cons-threshold 100000000) ;; 100mb ;; (setq read-process-output-max (* 1024 1024)) ;; 1mb ;; (setq lsp-idle-delay 0.500) ;; (setq lsp-log-io nil) ;; (setq lsp-completion-provider :capf) (setq lsp-prefer-flymake nil) ;; Makes LSP shutdown the metals server when all buffers in the project are closed. ;; https://emacs-lsp.github.io/lsp-mode/page/settings/mode/#lsp-keep-workspace-alive (setq lsp-keep-workspace-alive nil)) (with-eval-after-load 'flycheck (add-to-list 'flycheck-disabled-checkers 'python-flake8) (flycheck-add-next-checker 'python-pylint '(warning . python-flake8))) ;; Disable pylint for lsp-mode (setq lsp-pyls-plugins-pycodestyle-enabled nil) (setq lsp-pyls-plugins-flake8-enabled t) ;; Add metals backend for lsp-mode (use-package lsp-metals :ensure t) (when (display-graphic-p) ;; Do any keybindings and theme setup here (use-package lsp-ui :ensure t :commands lsp-ui-mode) (use-package posframe :ensure t) (use-package dap-mode :ensure t :hook (lsp-mode . dap-mode) (lsp-mode . dap-ui-mode)) (use-package helm-lsp :ensure t :config (define-key lsp-mode-map [remap xref-find-apropos] #'helm-lsp-workspace-symbol) ) (use-package lsp-treemacs :ensure t) ) (defun my/python-mode-setup () (setq lsp-pylsp-configuration-sources [\"pycodestyle\"]) (setq lsp-pylsp-plugins-pydocstyle-enabled t) (setq lsp-pylsp-plugins-pydocstyle-ignore [\"D100\" \"D101\" \"D203\", \"D107\", \"D105\", \"D104\", \"D102\", \"D103\", \"D106\", \"D401\", \"D413\", \"D202\", \"D204\", \"D213\", \"D406\", \"D407\", \"D408\", \"D409\", \"D410\", \"D411\", \"D412\", \"D415\", \"D416\", \"D417\", \"D418\", \"D419\", \"D420\", \"D421\", \"D422\", \"D423\", \"D424\", \"D425\", \"D426\", \"D427\", \"D428\", \"D429\", \"D430\", \"D431\", \"D432\", \"D433\", \"D434\", \"D435\", \"D436\", \"D437\", \"D438\", \"D439\", \"D440\", \"D441\", \"D442\", \"D443\", \"D444\", \"D445\", \"D446\", \"D447\", \"D448\", \"D449\", \"D450\", \"D451\", \"D452\", \"D453\", \"D454\", \"D455\", \"D456\", \"D457\", \"D458\", \"D459\", \"D460\", \"D461\", \"D462\", \"D463\", \"D464\", \"D465\", \"D466\", \"D467\", \"D468\", \"D469\", \"D470\", \"D471\", \"D472\", \"D473\", \"D474\", \"D475\", \"D476\", \"D477\", \"D478\", \"D479\", \"D480\", \"D481\", \"D482\", \"D483\", \"D484\", \"D485\", \"D486\", \"D487\", \"D488\", \"D489\", \"D490\", \"D491\", \"D492\", \"D493\", \"D494\", \"D495\", \"D496\", \"D497\", \"D498\", \"D499\", \"D500\", \"D501\", \"D502\", \"D503\", \"D504\", \"D505\", \"D506\", \"D507\", \"D508\", \"D509\", \"D510\", \"D511\", \"D512\", \"D513\", \"D514\", \"D515\", \"D516\", \"D517\", \"D518\", \"D519\", \"D520\", \"D521\", \"D522\"])) (add-hook 'python-mode-hook #'my/python-mode-setup) ","date":"2024-03-17","objectID":"/configure_emacs/:5:5","tags":["emacs"],"title":"Emacs配置文件","uri":"/configure_emacs/"},{"categories":null,"content":"语法检测 flymake (remove-hook 'prog-mode-hook 'flymake-mode) (remove-hook 'find-file-hook 'flymake-mode) (use-package python :mode (\"\\\\.py\" . python-mode) :ensure t :config (flymake-mode) ; ) ;; ;; Redefine flymake-mode to do nothing ;; (defun flymake-mode (\u0026optional arg) ;; \"Disable flymake mode.\" ;; (interactive) ;; ;; Do nothing ;; ) flycheck (use-package flycheck :ensure t :init (global-flycheck-mode) (setq flycheck-checkers '(lsp-ui)) ) ","date":"2024-03-17","objectID":"/configure_emacs/:5:6","tags":["emacs"],"title":"Emacs配置文件","uri":"/configure_emacs/"},{"categories":null,"content":"项目管理 (use-package projectile :ensure t :config (projectile-global-mode) (define-key projectile-mode-map (kbd \"C-c p\") 'projectile-command-map) (setq projectile-switch-project-action 'projectile-dired) (setq projectile-project-search-path '(\"~/Gitlab/offline/\" \"~/Gitlab/online/\" \"~/Github/PrivateHub\")) (projectile-register-project-type 'java '(\"pom.xml\") :compile \"mvn compile\" :test \"mvn test\" :run \"mvn package\" :test-suffix \"Test\") ) ","date":"2024-03-17","objectID":"/configure_emacs/:5:7","tags":["emacs"],"title":"Emacs配置文件","uri":"/configure_emacs/"},{"categories":null,"content":"other (use-package quickrun :ensure t :config (quickrun-add-command \"c++/c11\" '((:command . \"g++\") (:exec . (\"%c -std=c++11 %o -o %e %s\" \"%e %a\")) (:remove . (\"%e\"))) :default \"c++\") ) ;; Enable scala-mode and sbt-mode ;; eglot metal 的配置 ;; (use-package eglot ;; :pin melpa-stable ;; ;; (optional) Automatically start metals for Scala files. ;; ;; :hook (scala-mode . eglot-ensure) ;; :config ;; (setq eldoc-echo-area-use-multiline-p nil) ;; ;; (add-hook 'eglot--managed-mode-hook (lambda () (flymake-mode -1))) ;; ) ;;需要安装metals-emacs ;; sudo coursier bootstrap \\ ;; --java-opt -XX:+UseG1GC \\ ;; --java-opt -XX:+UseStringDeduplication \\ ;; --java-opt -Xss4m \\ ;; --java-opt -Xms100m \\ ;; org.scalameta:metals_2.13:0.11.10 \\ ;; -o /usr/local/bin/metals-emacs -f (setq lsp-pyls-plugins-pycodestyle-enabled nil) ;; other important (use-package wgrep :ensure t) (use-package multiple-cursors :ensure t :bind ((\"C-\u003e\" . mc/mark-next-like-this) (\"C-\u003c\" . mc/mark-previous-like-this) (\"C-M-\u003e\" . mc/skip-to-next-like-this) (\"C-M-\u003c\" . mc/skip-to-previous-like-this) (\"C-c C-\u003c\" . mc/mark-all-like-this) (\"C-S-c C-S-c\" . mc/edit-lines) (\"C-S-\u003cmouse-1\u003e\" . mc/add-cursor-on-click) :map mc/keymap (\"C-|\" . mc/vertical-align-with-space)) :config (setq mc/insert-numbers-default 1)) ;; yasnippet (when (display-graphic-p) (use-package auto-highlight-symbol :ensure t :config (global-auto-highlight-symbol-mode t) ) (use-package projectile-rails :ensure t :config (projectile-rails-global-mode) ) (use-package highlight-indent-guides :ensure t :config (add-hook 'python-mode-hook 'highlight-indent-guides-mode) (setq highlight-indent-guides-method 'character)) ) ","date":"2024-03-17","objectID":"/configure_emacs/:5:8","tags":["emacs"],"title":"Emacs配置文件","uri":"/configure_emacs/"},{"categories":null,"content":"yasnippet (use-package yasnippet :ensure t :config (setq yas-snippet-dirs '(\"~/Github/PrivateHub/tech_org/dotfiles/emacs_snippets\" )) (yas-global-mode 1) ) (use-package yasnippet-snippets :ensure t ) ","date":"2024-03-17","objectID":"/configure_emacs/:5:9","tags":["emacs"],"title":"Emacs配置文件","uri":"/configure_emacs/"},{"categories":null,"content":"languages 各种小语言 (use-package protobuf-mode :ensure t ) (use-package yaml-mode :ensure t :config (add-to-list 'auto-mode-alist '(\"\\\\.yml\\\\'\" . yaml-mode)) ) (use-package go-mode :ensure t :config (autoload 'go-mode \"go-mode\" nil t) (add-to-list 'auto-mode-alist '(\"\\\\.go\\\\'\" . go-mode)) ) (use-package scala-mode :interpreter (\"scala\" . scala-mode)) ;; Enable sbt mode for executing sbt commands (use-package sbt-mode :commands sbt-start sbt-command :config ;; WORKAROUND: https://github.com/ensime/emacs-sbt-mode/issues/31 ;; allows using SPACE when in the minibuffer (substitute-key-definition 'minibuffer-complete-word 'self-insert-command minibuffer-local-completion-map) ;; sbt-supershell kills sbt-mode: https://github.com/hvesalai/emacs-sbt-mode/issues/152 (setq sbt:program-options '(\"-Dsbt.supershell=false\"))) python ;; (when (display-graphic-p) ;; (use-package elpy ;; :ensure t ;; :init ;; (elpy-enable)) ;; ) (add-hook 'python-mode-hook (lambda () (setq indent-tabs-mode nil) (setq tab-width 4) (setq python-indent-offset 4))) (add-hook 'python-mode-hook (lambda () ;; (setq flycheck-python-pylint-executable \"/Users/mobvista/miniforge3/envs/tf26/bin/pylint\") ;; (setq flycheck-pylintrc \"~/.pylintrc\") ;; (setq flycheck-flake8rc \"~/.config/flake8\") ) ) ;; 关于anaconda，先安装conda，使用conda-activate可以切换conda环境 (use-package conda :ensure t :init (setq conda-anaconda-home (expand-file-name \"~/miniforge3/\")) (setq conda-env-home-directory (expand-file-name \"~/miniforge3\")) (setq-default mode-line-format (cons mode-line-format '(:exec conda-env-current-name))) (if (display-graphic-p) (progn (conda-env-activate \"py39\") ) (progn (conda-env-activate \"py39\") ) ) ) ;; anaconda-mode定义了很多跳转功能，比如 anaconda-mode-find-definitions M.,M= ;; (use-package anaconda-mode ;; :ensure t ;; :bind ((\"C-c C-x\" . next-error)) ;; :config ;; (add-hook 'python-mode-hook 'anaconda-mode) ;; (add-hook 'python-mode-hook 'anaconda-eldoc-mode) ;; ) ;; (use-package company-anaconda ;; :ensure t ;; :config ;; (eval-after-load \"company\" ;; '(add-to-list 'company-backends '(company-anaconda)))) ;; (use-package company-shell ;; :ensure t ;; :config ;; (eval-after-load \"company\" ;; '(add-to-list 'company-backends '(company-shell company-shell-env)))) ;(use-package company-jedi ; :ensure t ; ) ;(use-package company-irony ; :ensure t ; :config ; (eval-after-load \"company\" ; '(add-to-list 'company-backends '(company-irony)))) ;; PYTHON CONFIG END ;; 可以让imenu 平铺起来flat (defun python-imenu-use-flat-index () (setq imenu-create-index-function #'python-imenu-create-flat-index)) (add-hook 'python-mode-hook #'python-imenu-use-flat-index) (use-package py-autopep8 :hook ((python-mode) . py-autopep8-mode)) (use-package dap-mode :ensure t :config (dap-mode 1) ;; The modes below are optional (dap-ui-mode 1) ;; enables mouse hover support (dap-tooltip-mode 1) ;; use tooltips for mouse hover ;; if it is not enabled `dap-mode' will use the minibuffer. (tooltip-mode 1) ;; displays floating panel with debug buttons ;; requies emacs 26+ (dap-ui-controls-mode 1) (require 'dap-python) ;; if you installed debugpy, you need to set this ;; https://github.com/emacs-lsp/dap-mode/issues/306 (setq dap-python-debugger 'debugpy) ) (when (display-graphic-p) ;; Do any keybindings and theme setup here (use-package realgud :ensure t) (use-package ein :ensure t) (use-package python-pytest) ) ;; run-python 使用ipython (setq python-shell-completion-native-enable nil) (when (executable-find \"ipython\") (setq python-shell-interpreter \"ipython\")) c++ (require 'cc-mode) (add-hook 'c++-mode-hook (lambda () (setq flycheck-clang-language-standard \"c++11\"))) (use-package smartparens :ensure t :config (add-hook 'prog-mode-hook 'smartparens-mode) ) (use-package smartparens-config :ensure smartparens :config (progn (show-smartparens-global-mode t))) (setq smartparens-strict-mode nil) (defmacro def-pairs (pairs) \"Define functions for pairing. PAIRS is an alist of (NAME . STRING) conses, where NAME is the function name that will be created","date":"2024-03-17","objectID":"/configure_emacs/:5:10","tags":["emacs"],"title":"Emacs配置文件","uri":"/configure_emacs/"},{"categories":null,"content":"org ","date":"2024-03-17","objectID":"/configure_emacs/:6:0","tags":["emacs"],"title":"Emacs配置文件","uri":"/configure_emacs/"},{"categories":null,"content":"appearance org basic (defun dw/org-mode-setup () (org-indent-mode) (variable-pitch-mode 1) (auto-fill-mode 0) (visual-line-mode 1) (setq evil-auto-indent nil) (diminish org-indent-mode)) (use-package org :defer t :hook (org-mode . dw/org-mode-setup) :config (setq org-ellipsis \" ▾\" org-hide-emphasis-markers t org-src-fontify-natively t org-fontify-quote-and-verse-blocks t org-src-tab-acts-natively t org-edit-src-content-indentation 2 org-hide-block-startup nil org-src-preserve-indentation nil org-startup-folded 'content org-cycle-separator-lines 2 org-capture-bookmark nil) (setq inferior-lisp-program \"/opt/homebrew/bin/sbcl\") (setq org-imenu-depth 4) (org-babel-do-load-languages 'org-babel-load-languages '((emacs-lisp . t) (python . t) )) (push '(\"conf-unix\" . conf-unix) org-src-lang-modes) (add-to-list 'org-file-apps '(\"\\\\.pdf\\\\'\" . (lambda (file link) (find-file file)))) ) table 中文 (use-package valign :hook (org-mode . valign-mode) :config (setq valign-fancy-bar t) ) 页面宽度 (visual-fill-column) (defun my/org-mode-visual-fill () (interactive) (setq visual-fill-column-width 150 visual-fill-column-center-text t) (visual-fill-column-mode 1)) (use-package visual-fill-column :hook (org-mode . my/org-mode-visual-fill)) 插入图片 (use-package org-download :bind (\"C-S-y\" . org-download-clipboard) :config (add-hook 'dired-mode-hook 'org-download-enable) (setq-default org-download-heading-lvl nil) ;; (setq org-image-actual-width 600) (setq-default org-download-image-dir \"./images\")) 字体 (setq-default fill-column 80) (set-fontset-font t 'symbol \"Apple Color Emoji\" nil 'prepend) (setq org-image-actual-width nil) (setq org-html-htmlize-output-type nil) (add-hook 'org-mode-hook (lambda () (set-face-attribute 'default nil :font \"Menlo-15\"))) (require 'org-faces) (set-face-attribute 'org-document-title nil :font \"Menlo-15\" :weight 'bold :height 2.7) (dolist (face '((org-level-1 . 1.2) (org-level-2 . 1.06) (org-level-3 . 1.03) (org-level-4 . 1.0) (org-level-5 . 1.0) (org-level-6 . 1.0) (org-level-7 . 1.0) (org-level-8 . 1.0) (org-table . 1.0) )) (set-face-attribute (car face) nil :font \"Menlo-15\" :weight 'medium :height (cdr face))) (require 'org-indent) (set-face-attribute 'fixed-pitch nil :font \"Menlo-15\" :weight 'light :height 1.0) (set-face-attribute 'variable-pitch nil ;; :font \"Cantarell\" :font \"Menlo-15\" :height 1.0 :weight 'light) (set-face-attribute 'org-block nil :foreground nil :inherit 'fixed-pitch) (set-face-attribute 'org-table nil :inherit 'fixed-pitch) ;; (set-face-attribute 'org-table nil :height 0.95) (set-face-attribute 'org-formula nil :inherit 'fixed-pitch) (set-face-attribute 'org-code nil :inherit '(shadow fixed-pitch)) (set-face-attribute 'org-indent nil :inherit '(org-hide fixed-pitch)) (set-face-attribute 'org-verbatim nil :inherit '(shadow fixed-pitch)) (set-face-attribute 'org-special-keyword nil :inherit '(font-lock-comment-face fixed-pitch)) (set-face-attribute 'org-meta-line nil :inherit '(font-lock-comment-face fixed-pitch)) (set-face-attribute 'org-checkbox nil :inherit 'fixed-pitch) ;; Get rid of the background on column views (set-face-attribute 'org-column nil :background nil) (set-face-attribute 'org-column-title nil :background nil) (require 'color) (set-face-attribute 'org-block nil :background (color-lighten-name (face-attribute 'default :background) 25)) ;; (custom-set-faces ;; '(org-block-begin-line ;; ((t (:background \"lightgreen\" :foreground \"black\")))) ;; '(org-block-end-line ;; ((t (:background \"lightgreen\" :foreground \"black\"))))) (set-face-attribute 'org-block-begin-line nil :background (color-lighten-name (face-attribute 'default :background) 50)) (set-face-attribute 'org-block-end-line nil :background (color-lighten-name (face-attribute 'default :background) 50)) prettify-symbols-alist (add-hook 'org-mode-hook (lambda () (setq prettify-symbols-alist '( ;; (\"lambda\" . ?λ) (\"#+TITLE:\" . \"📗\") (\"#+AUTHOR:\" . \"👤\") (\"#+DATE:\" . \"📅\") (\"#+EMAIL:\" . \"🌐\") (\"TODO\" . \"📌\") (\"DONE\" . \"✅\") (\"1) \" . \"1️⃣\") (\"2) \" . \"2","date":"2024-03-17","objectID":"/configure_emacs/:6:1","tags":["emacs"],"title":"Emacs配置文件","uri":"/configure_emacs/"},{"categories":null,"content":"presentation org-tree-slide treeslide (use-package hide-mode-line) (defun efs/presentation-setup () (setq org-format-latex-options (plist-put org-format-latex-options :scale 2.1)) (org-latex-preview '(16)) (setq visual-fill-column-width 110 visual-fill-column-center-text t) ; 调整显示界面 ;; Center the presentation and wrap lines (visual-fill-column-mode 1) (visual-line-mode 1) (setq header-line-format \" \") ; 在标题前加入空行 (display-line-numbers-mode 0) (org-display-inline-images) (tooltip-mode -1) ;可以在鼠标hover到图片的时候不显示图片的名字 ;; Scale the text. The next line is for basic scaling: ;; (setq text-scale-mode-amount 3) (setq-local face-remapping-alist '((default (:height 1.3 ) variable-pitch) (header-line (:height 1.8 ) variable-pitch) (org-document-title (:height 2.0) org-document-title) (org-level-1 (:height 1.5 ) org-level-1) (org-level-2 (:height 1.35 ) org-level-2) (org-level-3 (:height 1.05 ) org-level-3) (org-code (:height 1.0 ) org-code) (org-verbatim (:height 0.9 ) org-verbatim) (org-block (:height 0.8 ) org-block) (org-block-begin-line (:height 1.05) org-block) (org-list-dt (:height 1.2) org-list-dt) ) ) ) (defun efs/presentation-end () ;; (hide-mode-line-mode 0) (setq-local face-remapping-alist '((default variable-pitch default))) (setq org-format-latex-options (plist-put org-format-latex-options :scale 1.8)) (tooltip-mode 1) ) (defun my-make-invisible (my-re) (interactive \"sRE Search Term: \") (save-excursion (goto-char (point-min)) (while (re-search-forward my-re nil t) (setq invisible-overlay (make-overlay (line-beginning-position) (line-end-position))) (overlay-put invisible-overlay 'invisible t)))) (defun my-make-visible (my-re) (interactive \"sRE Search Term: \") (save-excursion (goto-char (point-min)) (while (re-search-forward my-re nil t) (let ((overlays (overlays-in (line-beginning-position) (line-end-position)))) (dolist (overlay overlays) (when (overlay-get overlay 'invisible) (delete-overlay overlay))))))) (defun my-org-tree-slide-hide-lines () (my-make-invisible \"#\\\\+ATTR_HTML\\\\|#\\\\+DOWNLOADED\") ) (defun my-org-tree-slide-show-lines () (my-make-visible \"#\\\\+ATTR_HTML\\\\|#\\\\+DOWNLOADED\") ) (use-package org-tree-slide :hook ((org-tree-slide-play . efs/presentation-setup) (org-tree-slide-stop . efs/presentation-end)) :custom (org-tree-slide-slide-in-effect nil) (org-tree-slide-activate-message \"Presentation started!\") (org-tree-slide-deactivate-message \"Presentation finished!\") (org-tree-slide-header nil) (org-tree-slide-breadcrumbs \" \u003e \") (org-tree-slide-skip-outline-level 3) ;; 只对level1,2做slides (org-tree-slide-heading-emphasis t) (org-tree-slide-fold-subtrees-skipped t) ;; 是否对level3 以下的subtree做折叠 (org-tree-slide-cursor-init t) (org-image-actual-width nil) :config (add-hook 'org-tree-slide-play-hook 'my-org-tree-slide-hide-lines) (add-hook 'org-tree-slide-stop-hook 'my-org-tree-slide-show-lines) (global-set-key (kbd \"\u003cf8\u003e\") 'org-tree-slide-mode) :bind (([f8] . org-tree-slide-mode) ) ) (with-eval-after-load 'org-tree-slide (define-key org-tree-slide-mode-map (kbd \"\u003cleft\u003e\") 'org-tree-slide-move-previous-tree) (define-key org-tree-slide-mode-map (kbd \"\u003cright\u003e\") 'org-tree-slide-move-next-tree) (define-key org-tree-slide-mode-map (kbd \"\u003cup\u003e\") 'org-previous-visible-heading) (define-key org-tree-slide-mode-map (kbd \"\u003cdown\u003e\") 'org-next-visible-heading) (define-key org-tree-slide-mode-map (kbd \"C-\u003e\") 'mc/mark-next-like-this) (define-key org-tree-slide-mode-map (kbd \"C-\u003c\") 'mc/mark-previous-like-this) ) org-present (use-package org-present :config (defun my/org-present-prepare-slide (buffer-name heading) (org-overview) ; 仅显示顶层标题Show only top-level headlines (org-show-entry); 展开当前标题Unfold the current entry (org-show-children)) ; 显示当前子标题 (defun my/org-present-start () ; 开始幻灯片的设置 ;; (turn-off-evil-mode) (org-present-hide-cursor) ; 隐藏光标 (org-latex-preview '(16)) (setq visual-fill-column-width 110 visual-fill-column-center-text t) ; 调整显示界面 ;; Center the presentation and wrap lines (visual-fill-column-mode 1) (visual-line-mode 1) ;; 调整字体大小 (s","date":"2024-03-17","objectID":"/configure_emacs/:6:2","tags":["emacs"],"title":"Emacs配置文件","uri":"/configure_emacs/"},{"categories":null,"content":"org-capture ;; about org-capture (setq my-todo-file \"~/Documents/OrgDoc/todos.org\") (setq my-idea-file \"~/Documents/OrgDoc/ideas.org\") (setq org-agenda-files (list my-todo-file \"~/Github/PrivateHub/tech_org/Linux/Emacs.org\" \"~/Github/PrivateHub/tech_org/Linux/mac.org\" )) (require 'helm) (helm-mode 1) (setq org-refile-targets '((nil :maxlevel . 1) (org-agenda-files :maxlevel . 1))) (setq org-completion-use-ido nil) (setq org-outline-path-complete-in-steps nil) (setq org-refile-use-outline-path 'file) (define-key global-map \"\\C-ca\" 'org-agenda) (define-key global-map \"\\C-cc\" 'org-capture) (setq org-default-notes-file (concat org-directory \"~/notes.org\")) (setq org-capture-templates nil) (add-to-list 'org-capture-templates '(\"t\" \"TODOS\")) (add-to-list 'org-capture-templates '(\"th\" \"TODO HOME\" entry (file+headline my-todo-file \"Home\") \"* TODO %^{任务名}\\n%u\\n\" )) (add-to-list 'org-capture-templates '(\"tt\" \"TODO TECH\" entry (file+headline my-todo-file \"Technology\") \"* TODO %^{任务名}\\n%u\\n\")) (add-to-list 'org-capture-templates '(\"te\" \"TODO ECONOMY\" entry (file+headline my-todo-file \"ECONOMY\") \"* TODO %^{任务名}\\n%u\\n\")) (add-to-list 'org-capture-templates '(\"i\" \"IDEAS\")) (add-to-list 'org-capture-templates '(\"it\" \"关于技术的思考\" entry (file+headline my-idea-file \"Technology\") \"* %^{heading}\\n%U\\n\")) (add-to-list 'org-capture-templates '(\"il\" \"关于人生的思考\" entry (file+headline my-idea-file \"Life\") \"* %^{heading}\\n%U\\n\")) (add-to-list 'org-capture-templates '(\"j\" \"Journal\" entry (file+datetree \"~/Documents/OrgDoc/journal.org\") \"* %U - %^{heading}\\n %?\")) (add-to-list 'org-capture-templates '(\"s\" \"Skills\" entry (file \"~/Documents/OrgDoc/skill.org\") \"* %^{heading} %t %^g\\n %?\\n\")) (add-to-list 'org-capture-templates '(\"b\" \"Billing\" plain (file+function \"~/Documents/OrgDoc/billing.org\" find-month-tree) \" | %U | %^{类别} | %^{描述} | %^{金额} |\" :kill-buffer t)) (defun get-year-and-month () (list (format-time-string \"%Y年\") (format-time-string \"%m月\"))) (defun find-month-tree () (let* ((path (get-year-and-month)) (level 1) end) (unless (derived-mode-p 'org-mode) (error \"Target buffer \\\"%s\\\" should be in Org mode\" (current-buffer))) (goto-char (point-min)) ;移动到 buffer 的开始位置 ;; 先定位表示年份的 headline，再定位表示月份的 headline (dolist (heading path) (let ((re (format org-complex-heading-regexp-format (regexp-quote heading))) (cnt 0)) (if (re-search-forward re end t) (goto-char (point-at-bol)) ;如果找到了 headline 就移动到对应的位置 (progn ;否则就新建一个 headline (or (bolp) (insert \"\\n\")) (if (/= (point) (point-min)) (org-end-of-subtree t t)) (insert (make-string level ?*) \" \" heading \"\\n\")))) (setq level (1+ level)) (setq end (save-excursion (org-end-of-subtree t t)))) (org-end-of-subtree))) ","date":"2024-03-17","objectID":"/configure_emacs/:6:3","tags":["emacs"],"title":"Emacs配置文件","uri":"/configure_emacs/"},{"categories":null,"content":"edit (require 'org-tempo) (add-to-list 'org-structure-template-alist '(\"sh\" . \"src sh\")) (add-to-list 'org-structure-template-alist '(\"el\" . \"src emacs-lisp\")) (add-to-list 'org-structure-template-alist '(\"li\" . \"src lisp\")) (add-to-list 'org-structure-template-alist '(\"sc\" . \"src scheme\")) (add-to-list 'org-structure-template-alist '(\"ts\" . \"src typescript\")) (add-to-list 'org-structure-template-alist '(\"py\" . \"src python\")) (add-to-list 'org-structure-template-alist '(\"go\" . \"src go\")) (add-to-list 'org-structure-template-alist '(\"yaml\" . \"src yaml\")) (add-to-list 'org-structure-template-alist '(\"json\" . \"src json\")) (add-to-list 'org-structure-template-alist '(\"chat\" . \"ai\")) (add-to-list 'org-structure-template-alist '(\"tangle\" . \"src emacs-lisp :tangle ~/Github/PrivateHub/linux_confs/emacs_personal/org_conf.el :comments link\")) ","date":"2024-03-17","objectID":"/configure_emacs/:6:4","tags":["emacs"],"title":"Emacs配置文件","uri":"/configure_emacs/"},{"categories":null,"content":"my config (defun todo-to-int (todo) (cl-first (-non-nil (mapcar (lambda (keywords) (let ((todo-seq (-map (lambda (x) (cl-first (split-string x \"(\"))) (cl-rest keywords)))) (cl-position-if (lambda (x) (string= x todo)) todo-seq))) org-todo-keywords)))) (defun my/org-sort-key () (let* ((todo-max (apply #'max (mapcar #'length org-todo-keywords))) (todo (org-entry-get (point) \"TODO\")) (todo-int (if todo (todo-to-int todo) todo-max)) (priority (org-entry-get (point) \"PRIORITY\")) (priority-int (if priority (string-to-char priority) org-default-priority))) (format \"%03d %03d\" todo-int priority-int) )) (defun my/org-sort-entries () (interactive) (org-sort-entries nil ?f #'my/org-sort-key)) (defun my-tbl-export (name) \"Search for table named `NAME` and export.\" (interactive \"s\") (outline-show-all) (let ((case-fold-search t)) (if (search-forward-regexp (concat \"#\\\\+NAME: +\" name) nil t) (progn (next-line) (org-table-export (format \"%s.csv\" name) \"orgtbl-to-csv\"))))) (defun org-babel-goto-src-block-end () \"Move the point to the end of the current Org-mode source block.\" (interactive) ;; Go to the beginning of the source block (org-babel-goto-src-block-head) ;; Enable case-insensitive searching (let ((case-fold-search t)) ;; Move forward to the end of the block (while (and (not (looking-at \"#\\\\+end_src\")) (not (eobp))) (forward-line 1)) (when (looking-at \"#\\\\+end_src\") ;; Move to the end of the #+END_SRC line (end-of-line)))) ","date":"2024-03-17","objectID":"/configure_emacs/:6:5","tags":["emacs"],"title":"Emacs配置文件","uri":"/configure_emacs/"},{"categories":null,"content":"denote (use-package denote :bind ((\"C-c n n\" . denote) (\"C-c n i\" . denote-link-or-create) (\"C-c n I\" . denote-link) (\"C-c n b\" . denote-link-backlinks) (\"C-c n a\" . denote-add-front-matter) (\"C-c n r\" . denote-rename-file) (\"C-c n R\" . denote-rename-file-using-front-matter) ) ) (setq denote-directory (expand-file-name \"~/Github/PrivateHub/tech_org/denotes/\") denote-known-keywords '(\"emacs\" \"python\" \"llm\" \"history\") denote-infer-keywords t denote-sort-keywords t denote-allow-multi-word-keywords t denote-date-prompt-use-org-read-date t denote-link-fontify-backlinks t denote-front-matter-date-format 'org-timestamp denote-prompts '(title keywords)) ;; 在work目录下创建标签为work的笔记 (defun my-work-notes () \"Create an entry tagged 'journal', while prompting for a title.\" (interactive) (denote (denote--title-prompt) '(\"work\") 'denote-file-type '\"./work\")) ","date":"2024-03-17","objectID":"/configure_emacs/:6:6","tags":["emacs"],"title":"Emacs配置文件","uri":"/configure_emacs/"},{"categories":null,"content":"helm-org 这个可以方便快速的在headline中查看org的内容 (use-package helm-org :ensure t :after org :bind ((\"C-c ho\" . helm-org-in-buffer-headings)) :custom (add-to-list 'helm-completing-read-handlers-alist '(org-capture . helm-org-completing-read-tags)) (add-to-list 'helm-completing-read-handlers-alist '(org-set-tags . helm-org-completing-read-tags)) ) ","date":"2024-03-17","objectID":"/configure_emacs/:6:7","tags":["emacs"],"title":"Emacs配置文件","uri":"/configure_emacs/"},{"categories":null,"content":"zotero (use-package zotxt :ensure t :init (add-hook 'org-mode-hook #'org-zotxt-mode) ) ","date":"2024-03-17","objectID":"/configure_emacs/:6:8","tags":["emacs"],"title":"Emacs配置文件","uri":"/configure_emacs/"},{"categories":null,"content":"agenda (use-package org-super-agenda :config (setq org-agenda-custom-commands '((\"z\" \"Hugo view\" ((agenda \"\" ((org-agenda-span 'day) (org-super-agenda-groups '((:name \"Today\" :time-grid t :date today :todo \"TODAY\" :scheduled today :order 1))))) (alltodo \"\" ((org-agenda-overriding-header \"\") (org-super-agenda-groups '(;; Each group has an implicit boolean OR operator between its selectors. (:name \"Today\" :deadline today :face (:background \"black\")) (:name \"Passed deadline\" :and (:deadline past :todo (\"TODO\" \"WAITING\" \"HOLD\" \"NEXT\")) :face (:background \"#7f1b19\")) (:name \"Work important\" :and (:priority\u003e= \"B\" :category \"Work\" :todo (\"TODO\" \"NEXT\"))) (:name \"Work other\" :and (:category \"Work\" :todo (\"TODO\" \"NEXT\"))) (:name \"Important\" :priority \"A\") (:priority\u003c= \"B\" ;; Show this section after \"Today\" and \"Important\", because ;; their order is unspecified, defaulting to 0. Sections ;; are displayed lowest-number-first. :order 1) (:name \"Papers\" :file-path \"org/roam/notes\") (:name \"Waiting\" :todo \"WAITING\" :order 9) (:name \"On hold\" :todo \"HOLD\" :order 10))))))))) (add-hook 'org-agenda-mode-hook 'org-super-agenda-mode) ) ","date":"2024-03-17","objectID":"/configure_emacs/:6:9","tags":["emacs"],"title":"Emacs配置文件","uri":"/configure_emacs/"},{"categories":null,"content":"org-babel (org-babel-do-load-languages 'org-babel-load-languages '((python . t))) (setq inferior-lisp-program \"/opt/homebrew/bin/sbcl\") ","date":"2024-03-17","objectID":"/configure_emacs/:6:10","tags":["emacs"],"title":"Emacs配置文件","uri":"/configure_emacs/"},{"categories":null,"content":"auctex (use-package tex :ensure auctex :config (setq TeX-auto-save t) (setq TeX-parse-self t) (setq TeX-save-query nil) (setq TeX-PDF-mode t) (setq TeX-source-correlate-mode t) (setq TeX-source-correlate-method 'synctex) (setq TeX-view-program-selection '((output-pdf \"PDF Tools\"))) (setq TeX-view-program-list '((\"PDF Tools\" TeX-pdf-tools-sync-view)))) ","date":"2024-03-17","objectID":"/configure_emacs/:6:11","tags":["emacs"],"title":"Emacs配置文件","uri":"/configure_emacs/"},{"categories":null,"content":"cdlatex (use-package cdlatex :ensure t :config (add-hook 'LaTeX-mode-hook 'turn-on-cdlatex) (add-hook 'org-mode-hook #'org-cdlatex-mode) (setq org-format-latex-options (plist-put org-format-latex-options :scale 1.8)) (setq cdlatex-math-modify-alist '((?D \"\\\\mathbb\" nil nil nil nil)))) ","date":"2024-03-17","objectID":"/configure_emacs/:6:12","tags":["emacs"],"title":"Emacs配置文件","uri":"/configure_emacs/"},{"categories":null,"content":"encrypt ;; brew install gpg (require 'org-crypt) ;;当被加密的部份要存入硬碟时，自动加密回去 (org-crypt-use-before-save-magic) ;;设定要加密的tag 标签为secret (setq org-crypt-tag-matcher \"secret\") ;;避免secret 这个tag 被子项目继承造成重复加密 ;; (setq org-tags-exclude-from-inheritance (quote (\"secret\"))) ;;用于加密的GPG 金钥 ;;可以设定任何ID 或是设成nil 来使用对称式加密(symmetric encryption) (setq org-crypt-key nil) (defun ag/reveal-and-move-back () (org-reveal) (goto-char ag/old-point)) (defun ag/org-reveal-after-save-on () (setq ag/old-point (point)) (add-hook 'after-save-hook 'ag/reveal-and-move-back)) (defun ag/org-reveal-after-save-off () (remove-hook 'after-save-hook 'ag/reveal-and-move-back)) (add-hook 'org-babel-pre-tangle-hook 'ag/org-reveal-after-save-on) (add-hook 'org-babel-post-tangle-hook 'ag/org-reveal-after-save-off) ","date":"2024-03-17","objectID":"/configure_emacs/:6:13","tags":["emacs"],"title":"Emacs配置文件","uri":"/configure_emacs/"},{"categories":null,"content":"my funs my/org-kill-list-item (defun my/org-kill-list-item (\u0026optional delete) \"Kill list item at POINT. Delete if DELETE is non-nil. In interactive calls DELETE is the prefix arg.\" (interactive \"P\") (unless (org-at-item-p) (error \"Not at an item\")) (let* ((col (current-column)) (item (point-at-bol)) (struct (org-list-struct))) (org-list-send-item item (if delete 'delete 'kill) struct) (org-list-write-struct struct (org-list-parents-alist struct)) (org-list-repair) (org-move-to-column col))) my/org-which (defun my/org-which-function () (interactive) (when (eq major-mode 'org-mode) (concat (mapconcat 'identity (org-get-outline-path t) \" \u003e \") \" \") )) ;; this is for doom modeline configuration (setq global-mode-string (list '(:eval (my/org-which-function)))) ","date":"2024-03-17","objectID":"/configure_emacs/:6:14","tags":["emacs"],"title":"Emacs配置文件","uri":"/configure_emacs/"},{"categories":null,"content":"keybiddings (global-set-key \"\\C-xf\" 'helm-recentf) (global-set-key \"\\C-xg\" 'magit-status) (global-set-key \"\\C-z\" 'set-mark-command) (global-set-key (kbd \"C-x m\") 'eshell) (global-set-key (kbd \"C-c hs\") 'helm-swoop) (use-package general :ensure t :config (general-create-definer my-leader-def :prefix \"s-i\") (general-create-definer my-ctrl-leader-def :prefix \"C-c\") (my-leader-def \"is\" 'swiper-isearch \"*\" 'isearch-forward-symbol-at-point \"ttl\" 'toggle-truncate-lines \"sw\" 'ace-swap-window \"tf\" 'transpose-frame \"rf\" 'rotate-frame \"fi\" 'crux-find-user-init-file \"hs\" 'hs-show-block \"hh\" 'hs-hide-block \"oti\" 'org-toggle-item \"oth\" 'org-toggle-heading \"os\" 'org-tree-slide-mode \"ots\" 'org-tree-slide-mode \"C-f\" 'outline-forward-same-level \"C-b\" 'outline-backward-same-level \"C-n\" 'outline-next-heading \"C-p\" 'outline-previouse-heading \"C-u\" 'outline-up-heading )) (use-package move-text :ensure t :config (my-ctrl-leader-def \"\u003cup\u003e\" 'move-text-up \"\u003cdown\u003e\" 'move-text-down) (global-set-key [s-up] 'move-text-up) (global-set-key [s-down] 'move-text-down) ) (use-package crux :ensure t :config (global-set-key [(shift return)] 'crux-smart-open-line) (global-set-key (kbd \"M-o\") 'crux-smart-open-line) (global-set-key [(control shift return)] 'crux-smart-open-line-above) ;; (global-set-key (kbd \"C-c n\") 'crux-cleanup-buffer-or-region) (global-set-key (kbd \"C-M-z\") 'crux-indent-defun) (global-set-key (kbd \"C-c u\") 'crux-view-url) (global-set-key (kbd \"C-c D\") 'crux-delete-file-and-buffer) (global-set-key (kbd \"C-c d\") 'crux-duplicate-current-line-or-region) (global-set-key (kbd \"C-c M-d\") 'crux-duplicate-and-comment-current-line-or-region) (global-set-key (kbd \"C-c r\") 'crux-rename-buffer-and-file) (global-set-key (kbd \"C-c t\") 'vterm) (global-set-key (kbd \"C-c k\") 'crux-kill-other-buffers) (global-set-key (kbd \"C-c TAB\") 'crux-indent-rigidly-and-copy-to-clipboard) (global-set-key (kbd \"C-c i\") 'imenu-anywhere) ) (global-set-key (kbd \"C-+\") 'text-scale-increase) (global-set-key (kbd \"C--\") 'text-scale-decrease) (global-set-key (kbd \"M-/\") 'hippie-expand) ","date":"2024-03-17","objectID":"/configure_emacs/:7:0","tags":["emacs"],"title":"Emacs配置文件","uri":"/configure_emacs/"},{"categories":null,"content":"proxy (defun my/show-proxy () \"Show http/https proxy.\" (interactive) (if url-proxy-services (message \"proxy is on\" ) (message \"No proxy\"))) (defun my/set-proxy () \"Set http/https proxy.\" (interactive) (setq url-proxy-services '((\"no_proxy\" . \"^\\\\(localhost\\\\|10.*\\\\|192.168.*\\\\|172.*\\\\|127.0.0.1\\\\|::1\\\\)\") (\"http\" . \"127.0.0.1:61491\") (\"https\" . \"127.0.0.1:61491\"))) (my/show-proxy)) (defun my/unset-proxy () \"Unset http/https proxy.\" (interactive) (setq url-proxy-services nil) (my/show-proxy)) (defun my/toggle-proxy () \"Toggle http/https proxy.\" (interactive) (if url-proxy-services (unset-proxy) (my/set-proxy))) ","date":"2024-03-17","objectID":"/configure_emacs/:8:0","tags":["emacs"],"title":"Emacs配置文件","uri":"/configure_emacs/"},{"categories":null,"content":"customized functions ","date":"2024-03-17","objectID":"/configure_emacs/:9:0","tags":["emacs"],"title":"Emacs配置文件","uri":"/configure_emacs/"},{"categories":null,"content":"reselect (global-set-key (kbd \"\u003cf16\u003e\") 'set-markers-for-region) (global-set-key (kbd \"\u003cS-f6\u003e\") 'set-region-from-markers) (global-set-key (kbd \"\u003cs-S-f6\u003e\") 'unset-region-markers) (defun set-markers-for-region () (interactive) (make-local-variable 'm1) (make-local-variable 'm2) (setq m1 (copy-marker (mark))) (setq m2 (copy-marker (point))) (message \"set-markers-for-region activated\") ) (defun set-region-from-markers () (interactive) (set-mark m1) (goto-char m2) (message \"set-region-from-markers activated\") ) (defun unset-region-markers () (interactive) (set-marker m1 nil) (set-marker m2 nil) (message \"unset-region-markers activated\") ) ","date":"2024-03-17","objectID":"/configure_emacs/:9:1","tags":["emacs"],"title":"Emacs配置文件","uri":"/configure_emacs/"},{"categories":null,"content":"ifuns mannul install (load \"~/.emacs.d/my-download/query-replace-many/query-replace-many.el\") window management (defun my/chatgpt () (interactive) (progn (delete-other-windows) (split-window-right) (other-window 1) (chatgpt-shell) ) ) others (defalias 'reload-buffer 'revert-buffer) (defun say-region () \"Use macOS say command to speak the selected region.\" (interactive) (if (region-active-p) (shell-command-on-region (region-beginning) (region-end) \"say\") (message \"No region selected\"))) (defun my/copy-filename-and-line-number-to-kill-ring () \"Copy the current buffer's file name and the current line number to the kill ring.\" (interactive) (let* ((filename (buffer-file-name)) (line-number (line-number-at-pos)) (output (if filename (format \"%s:%d\" filename line-number) \"Buffer does not have a file name.\"))) (kill-new output) (message \"Copied to kill-ring: %s\" output))) (defun my/load-init-file () \"Load the init file\" (interactive) (load-file \"~/.emacs.d/init.el\") ) (defun my/find-ssh-custom-file () \"Edit the `ssh/custom-file', in another window.\" (interactive) (let ((ssh-custom-file \"~/.ssh/config\")) (find-file-other-window ssh-custom-file) (message (format \"opening %s\" ssh-custom-file)) ) ) (defun my/find-zshell-custom-file () \"Edit the `ssh/custom-file', in another window.\" (interactive) (let ((zshell-custom-file \"~/.zshrc\")) (find-file-other-window zshell-custom-file) (message (format \"opening %s\" zshell-custom-file)) ) ) (defun my/find-python-custom-file () \"Edit the `ssh/custom-file', in another window.\" (interactive) (let ((zshell-custom-file \"~/.ipython/profile_default/startup/ipython_init.py\")) (find-file-other-window zshell-custom-file) (message (format \"opening %s\" zshell-custom-file)) ) ) (defun my/dired-tmp-dir () \"Edit the `ssh/custom-file', in another window.\" (interactive) (let ((tmp-dir \"~/tmp/\")) (dired tmp-dir) (message (format \"opening %s\" tmp-dir)) ) ) (defun my/set-cursor-yellow () \"Set cursor color to yellow\" (interactive) (set-cursor-color \"yellow\") ) (defun my/org-remove-all-result-blocks () (interactive) (save-excursion (goto-char (point-min)) (while (search-forward \"#+begin_src \" nil t) (org-babel-remove-result)))) (global-set-key (kbd \"s-i fs\") 'my/find-ssh-custom-file) (global-set-key (kbd \"s-i fz\") 'my/find-zshell-custom-file) (global-set-key (kbd \"s-i fp\") 'my/find-python-custom-file) (global-set-key (kbd \"s-i ba\") 'python-nav-beginning-of-block) (global-set-key (kbd \"s-i be\") 'python-nav-end-of-block) (global-set-key (kbd \"s-i dt\") 'my/dired-tmp-dir) (global-set-key (kbd \"s-i odr\") 'my/org-remove-all-result-blocks) (setq path-to-ctags \"/opt/homebrew/opt/ctags/bin/ctags\") (defun create-tags (dir-name) \"Create tags file.\" (interactive \"DDirectory: \") (let ((icmd (format \"/opt/homebrew/opt/ctags/bin/ctags -f %s/TAGS -e -R %s\" (directory-file-name dir-name) (directory-file-name dir-name)))) (message (format \"I am creating tags for %s\" dir-name)) (message icmd) (shell-command icmd) )) ;; (format \"%s -f TAGS -e -R %s\" path-to-ctags (directory-file-name dir-name))) (defun load-buffer () \"load current elisp buffer\" (interactive) (load-file (buffer-file-name)) ) (defun beautify-json () (interactive) (let ((b (if mark-active (min (point) (mark)) (point-min))) (e (if mark-active (max (point) (mark)) (point-max)))) (shell-command-on-region b e \"python -mjson.tool\" (current-buffer) t))) (defun eshell-other-window () \"Open a `shell' in a new window.\" (interactive) (let ((buf (eshell))) (switch-to-buffer (other-buffer buf)) (switch-to-buffer-other-window buf))) ;; https://gitlab.mobvista.com/ad_algo/ltv_model/-/blob/main/setup.py ;; git@gitlab.mobvista.com:ad_algo/ltv_model.git (defun clipboard/set (astring) \"Copy a string to clipboard\" (with-temp-buffer (insert astring) (clipboard-kill-region (point-min) (point-max)))) (defun my/git-share () \"share a git url for current buffer.\" (interactive) (progn (setq relative-file-name (file-relative-name buffer-file-name (projectile-project-root))) (setq icmd (format \"python","date":"2024-03-17","objectID":"/configure_emacs/:9:2","tags":["emacs"],"title":"Emacs配置文件","uri":"/configure_emacs/"},{"categories":null,"content":"trading (use-package pine-script-mode :ensure t :pin melpa-stable :mode ((\"\\\\.pine\" . pine-script-mode))) ","date":"2024-03-17","objectID":"/configure_emacs/:10:0","tags":["emacs"],"title":"Emacs配置文件","uri":"/configure_emacs/"},{"categories":null,"content":"final (defvar my-keys-minor-mode-map (let ((map (make-sparse-keymap))) ;; (define-key projectile-rails-mode-map (kbd \"C-c r\") 'projectile-rails-command-map) (define-key map (kbd \"C-x g\") 'magit-status) (define-key map (kbd \"C-s\") 'isearch-forward) (define-key map (kbd \"C-c SPC\") 'ace-jump-mode) (define-key map (kbd \"C-x SPC\") 'rectangle-mark-mode) (global-set-key (kbd \"C-c g\") 'google-this-mode-submap) ;; (move-text-default-bindings) map) \"my-keys-minor-mode keymap.\") (define-minor-mode my-mode \"A minor mode so that my key settings override annoying major modes.\" :init-value t :lighter my-mode :keymap my-keys-minor-mode-map ) (my-mode 1) (setq inhibit-startup-screen t) (setq initial-buffer-choice t) (add-to-list 'default-frame-alist '(fullscreen . maximized)) (add-hook 'emacs-startup-hook 'delete-other-windows) ","date":"2024-03-17","objectID":"/configure_emacs/:11:0","tags":["emacs"],"title":"Emacs配置文件","uri":"/configure_emacs/"},{"categories":null,"content":"关于我 你好，我是连义江，本人博士毕业于北京大学数学科学学院，前百度凤巢主任架构师。 喜欢AI和数学。闲暇喜欢弹弹电吉他。 在这里，你会看到我对技术和生活的一些思考。 感谢你的访问！ ","date":"2024-02-02","objectID":"/about/:0:0","tags":null,"title":"","uri":"/about/"}]